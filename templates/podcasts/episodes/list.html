{% extends "base.html" %}
{% from "macros.html" import pagination as render_pagination %}

{% block title %}Episodes - {{ podcast.name }} - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="space-y-6" x-data="episodeFilters()">
    {% include "podcasts/_subnav.html" %}

    <!-- Upcoming Episode Widget -->
    {% if upcoming_episode %}
    <div class="bg-gradient-to-r from-primary-50 to-primary-100 rounded-xl border border-primary-200 overflow-hidden" x-data="{ showItems: false }">
        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-primary-200/50 flex flex-col gap-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="min-w-0">
                    <div class="flex items-start sm:items-center gap-2 flex-wrap">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-primary-600 text-white flex-shrink-0">
                            Up Next
                        </span>
                        <h3 class="font-semibold text-gray-900 text-sm sm:text-base">
                            {% if upcoming_episode.episode_number %}Ep {{ upcoming_episode.episode_number }}: {% endif %}{{ upcoming_episode.title }}
                        </h3>
                    </div>
                    <p class="text-xs sm:text-sm text-gray-600 mt-0.5">
                        {% if upcoming_episode.scheduled_date %}
                            {{ upcoming_episode.scheduled_date.strftime('%b %d, %Y') }}
                        {% else %}
                            No date scheduled
                        {% endif %}
                    </p>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <a href="{{ url_for('podcasts.edit_episode', podcast_id=podcast.id, episode_id=upcoming_episode.id) }}"
                       class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs sm:text-sm font-medium text-primary-700 bg-white border border-primary-300 rounded-lg hover:bg-primary-50 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Edit
                    </a>
                    <a href="{{ url_for('podcasts.live_episode', podcast_id=podcast.id, episode_id=upcoming_episode.id) }}"
                       class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs sm:text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Live
                    </a>
                </div>
            </div>
        </div>

        <div class="p-4 sm:p-6">
            <!-- Quick Add Form -->
            <form id="quick-add-form" class="mb-4 sm:mb-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="flex flex-col gap-2 sm:gap-3">
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <div class="flex-1">
                            <input type="text" id="quick-add-title" name="title" placeholder="Add a topic or item..." required
                                   class="w-full px-3 sm:px-4 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white text-sm sm:text-base">
                        </div>
                        <div class="flex gap-2">
                            <select id="quick-add-section" name="section"
                                    class="flex-1 sm:w-40 px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white text-sm">
                                {% for key, name, parent in upcoming_sections or [] %}
                                    <option value="{{ key }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" id="quick-add-btn"
                                    class="inline-flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 sm:py-2.5 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors text-sm sm:text-base">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                <span class="hidden sm:inline">Add</span>
                            </button>
                        </div>
                    </div>
                    <input type="text" id="quick-add-link" name="link" placeholder="Link (optional)"
                           class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white text-sm">
                </div>
            </form>

            <!-- Items by Section (Collapsible) -->
            {% set item_count = upcoming_items_by_section.values() | sum(start=[]) | list | length if upcoming_items_by_section else 0 %}
            <div class="border-t border-primary-200/50 pt-4 mt-4">
                <button type="button" @click="showItems = !showItems"
                        class="flex items-center gap-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-3">
                    <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-90': showItems }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span>Existing Items</span>
                    <span class="text-xs text-gray-500">({{ item_count }} item{% if item_count != 1 %}s{% endif %})</span>
                </button>

                <div x-show="showItems" x-collapse>
                    <div id="upcoming-items" class="space-y-4">
                        {% for key, name, parent in upcoming_sections or [] %}
                            {% if key in (upcoming_items_by_section or {}) %}
                            <div class="section-group" data-section="{{ key }}">
                                <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">{{ name }}</h4>
                                <ul class="space-y-1.5 section-items">
                                    {% for item in upcoming_items_by_section[key] %}
                                    <li class="flex items-start gap-2 text-sm bg-white px-3 py-2 rounded-lg border border-gray-200" data-item-id="{{ item.id }}">
                                        <span class="flex-1 text-gray-800">{{ item.title }}</span>
                                        {% if item.all_links %}
                                            <a href="{{ item.all_links[0] }}" target="_blank" rel="noopener" class="text-primary-600 hover:text-primary-700 flex-shrink-0">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                                </svg>
                                            </a>
                                        {% endif %}
                                        <button type="button" class="delete-item text-gray-400 hover:text-red-600 flex-shrink-0" title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    {% if not upcoming_items_by_section %}
                    <p id="no-items-msg" class="text-center text-gray-500 py-4">No items added yet. Use the form above to add topics!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Episodes</h1>
            <p class="text-sm text-gray-500"><span x-text="totalCount">{{ stats.total }}</span> episode{% if stats.total != 1 %}s{% endif %}</p>
        </div>
        <a href="{{ url_for('podcasts.new_episode', podcast_id=podcast.id) }}"
           class="inline-flex items-center gap-2 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 text-sm font-medium shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            New Episode
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-3 gap-2 sm:gap-4">
        <div class="bg-white rounded-xl border border-surface-200 p-3 sm:p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Drafts</p>
            <p class="text-xl sm:text-2xl font-bold text-amber-600 mt-1" x-text="draftsCount">{{ stats.drafts }}</p>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-3 sm:p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Done</p>
            <p class="text-xl sm:text-2xl font-bold text-emerald-600 mt-1" x-text="completedCount">{{ stats.completed }}</p>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-3 sm:p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Total</p>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1" x-text="totalCount">{{ stats.total }}</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl border border-surface-200 p-3 sm:p-4">
        <div class="flex flex-col sm:flex-row gap-3 sm:items-end">
            <div class="flex-1 min-w-0">
                <label class="block text-xs font-medium text-gray-600 mb-1.5">Search</label>
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" x-model="search" @input.debounce.300ms="applyFilters()" placeholder="Search episodes..."
                        class="w-full border border-surface-200 rounded-lg pl-10 pr-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <div x-show="loading" class="absolute right-3 top-1/2 -translate-y-1/2">
                        <svg class="animate-spin w-4 h-4 text-primary-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 sm:gap-3 items-end">
                <!-- Status Dropdown -->
                <div class="relative flex-1 sm:flex-initial" x-data="{ open: false }" @click.away="open = false">
                    <label class="block text-xs font-medium text-gray-600 mb-1.5">Status</label>
                    <button type="button" @click="open = !open"
                        class="flex items-center justify-between gap-2 w-full sm:min-w-[130px] border border-surface-200 rounded-lg px-3 py-2 text-sm bg-white hover:bg-surface-50 focus:ring-2 focus:ring-primary-500">
                        <span x-text="statusLabel"></span>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="open" x-transition class="absolute z-20 mt-1 w-full bg-white border border-surface-200 rounded-lg shadow-lg py-1">
                        <button type="button" @click="status = ''; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === '' }">All Status</button>
                        <button type="button" @click="status = 'draft'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'draft' }">Draft</button>
                        <button type="button" @click="status = 'recording'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'recording' }">Recording</button>
                        <button type="button" @click="status = 'completed'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'completed' }">Completed</button>
                    </div>
                </div>

                <button type="button" @click="clearFilters()" class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm flex-shrink-0">Clear</button>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" :class="{ 'opacity-50': loading }">
        {% include "podcasts/episodes/_table.html" %}
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    {{ render_pagination(pagination, 'podcasts.list_episodes', extra_params={'podcast_id': podcast.id, 'status': current_status, 'search': search}) }}
    {% endif %}
</div>

<script>
    function episodeFilters() {
        return {
            search: '{{ search or "" }}',
            status: '{{ current_status or "" }}',
            loading: false,
            totalCount: {{ stats.total }},
            draftsCount: {{ stats.drafts }},
            completedCount: {{ stats.completed }},

            get statusLabel() {
                const labels = { '': 'All Status', 'draft': 'Draft', 'recording': 'Recording', 'completed': 'Completed' };
                return labels[this.status] || 'All Status';
            },

            async applyFilters() {
                this.loading = true;
                const params = new URLSearchParams();
                if (this.search) params.set('search', this.search);
                if (this.status) params.set('status', this.status);
                params.set('ajax', '1');

                try {
                    const response = await fetch('{{ url_for("podcasts.list_episodes", podcast_id=podcast.id) }}?' + params.toString());
                    const html = await response.text();
                    document.getElementById('results-container').innerHTML = html;

                    const stats = document.getElementById('episode-stats');
                    if (stats) {
                        this.totalCount = parseInt(stats.dataset.total) || 0;
                        this.draftsCount = parseInt(stats.dataset.drafts) || 0;
                        this.completedCount = parseInt(stats.dataset.completed) || 0;
                    }

                    const urlParams = new URLSearchParams();
                    if (this.search) urlParams.set('search', this.search);
                    if (this.status) urlParams.set('status', this.status);
                    const newUrl = '{{ url_for("podcasts.list_episodes", podcast_id=podcast.id) }}' + (urlParams.toString() ? '?' + urlParams.toString() : '');
                    history.replaceState(null, '', newUrl);
                } catch (error) {
                    console.error('Search failed:', error);
                }

                this.loading = false;
            },

            clearFilters() {
                this.search = '';
                this.status = '';
                this.applyFilters();
            }
        }
    }

    {% if upcoming_episode %}
    // Quick-add functionality for upcoming episode
    (function() {
        const podcastId = {{ podcast.id }};
        const episodeId = {{ upcoming_episode.id }};
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        const form = document.getElementById('quick-add-form');
        const titleInput = document.getElementById('quick-add-title');
        const sectionSelect = document.getElementById('quick-add-section');
        const linkInput = document.getElementById('quick-add-link');
        const itemsContainer = document.getElementById('upcoming-items');
        const noItemsMsg = document.getElementById('no-items-msg');

        const sectionNames = {
            {% for key, name, parent in upcoming_sections or [] %}
            '{{ key }}': '{{ name }}',
            {% endfor %}
        };

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const title = titleInput.value.trim();
            const section = sectionSelect.value;
            const link = linkInput.value.trim();

            if (!title) return;

            const btn = document.getElementById('quick-add-btn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                const response = await fetch(`/podcasts/${podcastId}/episodes/${episodeId}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        title: title,
                        section: section,
                        links: link ? [link] : []
                    })
                });

                // Check if response is OK and is JSON
                const contentType = response.headers.get('content-type');
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Server error:', response.status, text.substring(0, 500));
                    alert(`Server error: ${response.status}`);
                    return;
                }
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 500));
                    alert('Unexpected response from server');
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    addItemToUI(data.item);
                    titleInput.value = '';
                    linkInput.value = '';
                    titleInput.focus();
                } else {
                    alert(data.error || 'Failed to add item');
                }
            } catch (err) {
                console.error('Error adding item:', err);
                alert('Failed to add item: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add';
            }
        });

        function addItemToUI(item) {
            if (noItemsMsg) noItemsMsg.style.display = 'none';

            let sectionGroup = itemsContainer.querySelector(`[data-section="${item.section}"]`);
            if (!sectionGroup) {
                sectionGroup = document.createElement('div');
                sectionGroup.className = 'section-group';
                sectionGroup.dataset.section = item.section;
                sectionGroup.innerHTML = `
                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">${sectionNames[item.section] || item.section}</h4>
                    <ul class="space-y-1.5 section-items"></ul>
                `;
                itemsContainer.appendChild(sectionGroup);
            }

            const itemsList = sectionGroup.querySelector('.section-items');
            const li = document.createElement('li');
            li.className = 'flex items-start gap-2 text-sm bg-white px-3 py-2 rounded-lg border border-gray-200';
            li.dataset.itemId = item.id;

            let linkHtml = '';
            if (item.links && item.links.length > 0) {
                linkHtml = `<a href="${item.links[0]}" target="_blank" rel="noopener" class="text-primary-600 hover:text-primary-700 flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>`;
            }

            li.innerHTML = `
                <span class="flex-1 text-gray-800">${escapeHtml(item.title)}</span>
                ${linkHtml}
                <button type="button" class="delete-item text-gray-400 hover:text-red-600 flex-shrink-0" title="Delete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;

            itemsList.appendChild(li);
        }

        itemsContainer.addEventListener('click', async function(e) {
            const deleteBtn = e.target.closest('.delete-item');
            if (!deleteBtn) return;

            const li = deleteBtn.closest('li');
            const itemId = li.dataset.itemId;

            if (!confirm('Delete this item?')) return;

            try {
                const response = await fetch(`/podcasts/${podcastId}/episodes/${episodeId}/items/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrfToken }
                });

                const data = await response.json();
                if (data.success) {
                    const sectionGroup = li.closest('.section-group');
                    li.remove();
                    if (sectionGroup && sectionGroup.querySelectorAll('li').length === 0) {
                        sectionGroup.remove();
                    }
                    if (itemsContainer.children.length === 0 && noItemsMsg) {
                        noItemsMsg.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error('Error deleting item:', err);
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    })();
    {% endif %}
</script>
{% endblock %}
