{% extends "base.html" %}

{% block title %}{{ 'Edit' if template else 'New' }} Template - {{ podcast.name }} - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="space-y-6">
{% include "podcasts/_subnav.html" %}
</div>

<div class="max-w-3xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold text-gray-900">{{ 'Edit' if template else 'New' }} Episode Template</h1>
            <p class="text-sm text-gray-500 mt-1">Define default sections, intro/outro content, and poll questions</p>
        </div>
        <a href="{{ url_for('podcasts.list_templates', podcast_id=podcast.id) }}"
           class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Cancel
        </a>
    </div>

    <!-- Form -->
    <form method="POST" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Basic Info -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Template Name *</label>
                    <input type="text" name="name" id="name" required maxlength="100"
                           value="{{ template.name if template else '' }}"
                           placeholder="e.g., MouseCast Standard, Quick News Format"
                           class="w-full border border-surface-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="description" rows="2"
                              placeholder="Brief description of when to use this template"
                              class="w-full border border-surface-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">{{ template.description if template else '' }}</textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="is_default" id="is_default"
                           {% if template and template.is_default %}checked{% endif %}
                           class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                    <label for="is_default" class="text-sm text-gray-700">Set as default template for new guides</label>
                </div>
            </div>
        </div>

        <!-- Default Sections -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Default Sections</h2>
            <p class="text-sm text-gray-500 mb-4">Select which sections to include by default in guides using this template</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {% set selected_keys = [] %}
                {% if template and template.default_sections %}
                    {% for s in template.default_sections %}
                        {% set _ = selected_keys.append(s.key) %}
                    {% endfor %}
                {% endif %}
                {% for key, name, parent in all_sections %}
                    <label class="flex items-center gap-2 p-3 rounded-lg border border-surface-200 hover:bg-surface-50 cursor-pointer">
                        <input type="checkbox" name="default_sections" value="{{ key }}"
                               {% if key in selected_keys or (not template and key in ['introduction', 'news_mice', 'community_recap', 'outro']) %}checked{% endif %}
                               class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                        <span class="text-sm text-gray-700">
                            {{ name }}
                            {% if parent %}
                                <span class="text-gray-400">({{ parent }})</span>
                            {% endif %}
                        </span>
                    </label>
                {% endfor %}
            </div>
        </div>

        <!-- Intro Static Content -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Intro Static Content</h2>
            <p class="text-sm text-gray-500 mb-4">Reminder text shown at the top of the intro section (one item per line)</p>
            <textarea name="intro_static_content" id="intro_static_content" rows="5"
                      placeholder="Hello everyone! Welcome to the show&#10;Subscribe&#10;Join our Discord"
                      class="w-full border border-surface-200 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">{% if template and template.intro_static_content %}{{ template.intro_static_content | join('\n') }}{% elif not template %}{{ default_intro | join('\n') }}{% endif %}</textarea>
        </div>

        <!-- Outro Static Content -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Outro Static Content</h2>
            <p class="text-sm text-gray-500 mb-4">Reminder text shown at the top of the outro section (one item per line)</p>
            <textarea name="outro_static_content" id="outro_static_content" rows="5"
                      placeholder="Thank you for listening&#10;See you next week"
                      class="w-full border border-surface-200 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">{% if template and template.outro_static_content %}{{ template.outro_static_content | join('\n') }}{% elif not template %}{{ default_outro | join('\n') }}{% endif %}</textarea>
        </div>

        <!-- Default Poll Questions -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Default Poll Questions</h2>
            <p class="text-sm text-gray-500 mb-4">Pre-fill poll question fields in new guides</p>
            <div class="space-y-4">
                <div>
                    <label for="default_poll_1" class="block text-sm font-medium text-gray-700 mb-1">Poll Question 1</label>
                    <input type="text" name="default_poll_1" id="default_poll_1" maxlength="200"
                           value="{{ template.default_poll_1 if template else '' }}"
                           placeholder="e.g., What's your main mouse right now?"
                           class="w-full border border-surface-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label for="default_poll_2" class="block text-sm font-medium text-gray-700 mb-1">Poll Question 2</label>
                    <input type="text" name="default_poll_2" id="default_poll_2" maxlength="200"
                           value="{{ template.default_poll_2 if template else '' }}"
                           placeholder="e.g., Which brand makes the best mousepads?"
                           class="w-full border border-surface-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>
        </div>

        {% if template %}
        <!-- Discord Integration -->
        <div class="bg-white rounded-xl border border-surface-200 p-6" x-data="discordConfig({{ podcast.id }}, {{ template.id }})">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                        Discord Community Topic Sourcing
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Import topics from Discord based on emoji reactions</p>
                </div>
                <template x-if="integration && integration.is_active">
                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        Active
                    </span>
                </template>
            </div>

            <!-- Error/Success Messages -->
            <template x-if="error">
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm" x-text="error"></div>
            </template>
            <template x-if="success">
                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm" x-text="success"></div>
            </template>

            <!-- Configuration Form -->
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Discord Server ID *</label>
                        <input type="text" x-model="config.guild_id" placeholder="e.g., 123456789012345678"
                               class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                        <p class="text-xs text-gray-400 mt-1">Right-click your server â†’ Copy Server ID</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Integration Name</label>
                        <input type="text" x-model="config.name" placeholder="e.g., MouseCast Community"
                               class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Channel ID(s) *</label>
                    <input type="text" x-model="config.channel_ids" placeholder="e.g., 123456789012345678 or comma-separated for multiple"
                           class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-primary-500">
                    <p class="text-xs text-gray-400 mt-1">One channel ID, or comma-separated list for multiple channels</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emoji to Scan For *</label>
                        <input type="text" x-model="config.scan_emoji" placeholder="e.g., ðŸ­"
                               class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                        <p class="text-xs text-gray-400 mt-1">Messages with this emoji reaction will appear in import</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bot Token Env Variable</label>
                        <input type="text" x-model="config.bot_token_env_var" placeholder="DISCORD_BOT_TOKEN"
                               class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" x-model="config.is_active" id="discord_active"
                           class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                    <label for="discord_active" class="text-sm text-gray-700">Integration active</label>
                </div>
                <div class="flex items-center gap-3">
                    <button type="button" @click="saveConfig()" :disabled="saving"
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                        <span x-show="!saving">Save Discord Settings</span>
                        <span x-show="saving">Saving...</span>
                    </button>
                    <button type="button" @click="testConnection()" :disabled="testing || !integration"
                            class="px-4 py-2 bg-white text-gray-700 text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                        <span x-show="!testing">Test Connection</span>
                        <span x-show="testing">Testing...</span>
                    </button>
                    <template x-if="integration">
                        <button type="button" @click="deleteIntegration()"
                                class="px-4 py-2 text-red-600 text-sm font-medium hover:text-red-700">
                            Remove Integration
                        </button>
                    </template>
                </div>
            </div>

        </div>
        {% endif %}

        <!-- Submit -->
        <div class="flex justify-end gap-3">
            <a href="{{ url_for('podcasts.list_templates', podcast_id=podcast.id) }}"
               class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit"
                    class="px-6 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 shadow-sm">
                {{ 'Save Changes' if template else 'Create Template' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function discordConfig(podcastId, templateId) {
    return {
        podcastId: podcastId,
        templateId: templateId,
        integration: null,
        sections: {},
        config: {
            name: '',
            guild_id: '',
            channel_ids: '',
            bot_token_env_var: 'DISCORD_BOT_TOKEN',
            is_active: true,
            scan_emoji: ''
        },
        saving: false,
        testing: false,
        error: null,
        success: null,

        async init() {
            await this.loadIntegration();
        },

        async loadIntegration() {
            try {
                const response = await fetch(`/podcasts/${this.podcastId}/templates/${this.templateId}/discord`);
                const data = await response.json();
                if (data.success) {
                    if (data.integration) {
                        this.integration = data.integration;
                        // Combine channel_id and scan_channel_ids into unified channel_ids field
                        let channelIds = data.integration.channel_ids || data.integration.scan_channel_ids || data.integration.channel_id || '';
                        this.config = {
                            name: data.integration.name || '',
                            guild_id: data.integration.guild_id || '',
                            channel_ids: channelIds,
                            bot_token_env_var: data.integration.bot_token_env_var || 'DISCORD_BOT_TOKEN',
                            is_active: data.integration.is_active,
                            scan_emoji: data.integration.scan_emoji || ''
                        };
                    }
                }
            } catch (error) {
                console.error('Failed to load Discord integration:', error);
            }
        },

        async saveConfig() {
            this.saving = true;
            this.error = null;
            this.success = null;

            try {
                const response = await fetch(`/podcasts/${this.podcastId}/templates/${this.templateId}/discord`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(this.config)
                });

                const data = await response.json();
                if (data.success) {
                    this.integration = data.integration;
                    this.success = 'Discord settings saved successfully!';
                } else {
                    this.error = data.error || 'Failed to save settings';
                }
            } catch (error) {
                console.error('Failed to save Discord config:', error);
                this.error = 'Failed to save settings. Please try again.';
            } finally {
                this.saving = false;
            }
        },

        async testConnection() {
            this.testing = true;
            this.error = null;
            this.success = null;

            try {
                const response = await fetch(`/podcasts/${this.podcastId}/templates/${this.templateId}/discord/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.success = data.message || 'Connection successful!';
                } else {
                    this.error = data.error || 'Connection failed';
                }
            } catch (error) {
                console.error('Failed to test connection:', error);
                this.error = 'Connection test failed. Please try again.';
            } finally {
                this.testing = false;
            }
        },

        async deleteIntegration() {
            if (!confirm('Remove Discord integration?')) return;

            try {
                const response = await fetch(`/podcasts/${this.podcastId}/templates/${this.templateId}/discord/delete`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.integration = null;
                    this.config = {
                        name: '',
                        guild_id: '',
                        channel_ids: '',
                        bot_token_env_var: 'DISCORD_BOT_TOKEN',
                        is_active: true,
                        scan_emoji: ''
                    };
                    this.success = 'Discord integration removed.';
                } else {
                    this.error = data.error || 'Failed to remove integration';
                }
            } catch (error) {
                console.error('Failed to delete emoji mapping:', error);
                this.error = 'Failed to delete mapping. Please try again.';
            }
        }
    };
}
</script>
{% endblock %}
