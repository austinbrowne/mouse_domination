{% extends "base.html" %}

{% block title %}Edit Snippet - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('atomizer.list_snippets') }}" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Edit Snippet</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-surface-100 text-gray-700">
                        {{ snippet.platform_display }}
                    </span>
                    <span class="text-sm text-gray-500">{{ snippet.created_at.strftime('%b %d, %Y at %H:%M') }}</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <form action="{{ url_for('atomizer.regenerate_snippet', id=snippet.id) }}" method="post" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="inline-flex items-center gap-2 bg-white border border-surface-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-surface-50 text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Regenerate
                </button>
            </form>
            <form action="{{ url_for('atomizer.delete_snippet', id=snippet.id) }}" method="post" class="inline" onsubmit="return confirm('Delete this snippet?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="inline-flex items-center gap-2 bg-white border border-red-300 text-red-600 px-3 py-2 rounded-lg hover:bg-red-50 text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete
                </button>
            </form>
        </div>
    </div>

    <form method="post" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Source Content (Read-only) -->
        <div class="bg-surface-50 rounded-xl border border-surface-200 p-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Source Content</h3>
                {% if snippet.source_title %}
                <span class="text-sm text-gray-500">{{ snippet.source_title }}</span>
                {% endif %}
            </div>
            <div class="text-sm text-gray-700 whitespace-pre-wrap max-h-40 overflow-y-auto bg-white rounded-lg p-4 border border-surface-200">{{ snippet.source_content }}</div>
        </div>

        <!-- Generated Content -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Generated Content</h3>
                <div class="flex items-center gap-2 text-sm">
                    <span id="char-count" class="{% if snippet.is_over_limit %}text-red-600 font-medium{% else %}text-gray-500{% endif %}">
                        {{ snippet.character_count }} / {{ platform_config.max_length if platform_config else '?' }} chars
                    </span>
                    <button type="button" onclick="copyContent()" class="text-primary-600 hover:text-primary-700 font-medium">Copy</button>
                </div>
            </div>

            <!-- Original Generated (collapsed if edited) -->
            {% if snippet.edited_content %}
            <details class="mb-4">
                <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">View original AI output</summary>
                <div class="mt-2 text-sm text-gray-600 bg-surface-50 rounded-lg p-3 whitespace-pre-wrap">{{ snippet.generated_content }}</div>
            </details>
            {% endif %}

            <!-- Editable Content -->
            <textarea name="edited_content" id="content-editor" rows="6"
                class="w-full border border-surface-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-primary-500 resize-none"
                oninput="updateCharCount()">{{ snippet.edited_content or snippet.generated_content }}</textarea>

            {% if snippet.is_over_limit %}
            <p class="text-xs text-red-600 mt-1">Content exceeds platform character limit. Consider editing to fit.</p>
            {% endif %}

            <!-- AI Info -->
            <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                {% if snippet.ai_model %}
                <span>Model: {{ snippet.ai_model }}</span>
                {% endif %}
                {% if snippet.generation_time_ms %}
                <span>Generated in {{ snippet.generation_time_ms }}ms</span>
                {% endif %}
                {% if snippet.hashtags %}
                <span>Hashtags: {{ snippet.hashtags|length }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Status & Metadata -->
        <div class="bg-white rounded-xl border border-surface-200 p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Status & Tracking</h3>

            <div class="grid md:grid-cols-2 gap-4">
                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Status</label>
                    <select name="status" class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                        {% for value, label in statuses %}
                        <option value="{{ value }}" {% if snippet.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Published URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Published URL</label>
                    <input type="url" name="published_url" value="{{ snippet.published_url or '' }}" placeholder="https://..."
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                </div>

                <!-- Rating -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">AI Quality Rating</label>
                    <select name="rating" class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                        <option value="">Not rated</option>
                        {% for i in range(1, 6) %}
                        <option value="{{ i }}" {% if snippet.rating == i %}selected{% endif %}>{{ i }} star{% if i > 1 %}s{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Feedback Notes -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Notes / Feedback</label>
                <textarea name="feedback_notes" rows="2" placeholder="Optional notes about this content..."
                    class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">{{ snippet.feedback_notes or '' }}</textarea>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <a href="{{ url_for('atomizer.list_snippets') }}" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
            <button type="submit" class="inline-flex items-center gap-2 bg-primary-600 text-white px-6 py-2.5 rounded-lg hover:bg-primary-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save Changes
            </button>
        </div>
    </form>

    {% if snippet.platform == 'twitter' %}
    <!-- Post to Twitter Section -->
    <div class="bg-white rounded-xl border border-surface-200 p-6 mt-6">
        <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            Post to Twitter
        </h3>

        {% if snippet.status == 'published' and snippet.published_url %}
            <div class="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <div>
                    <p class="text-sm font-medium text-green-800">Already posted</p>
                    <a href="{{ snippet.published_url }}" target="_blank" rel="noopener noreferrer" class="text-sm text-green-700 hover:underline inline-flex items-center gap-1">
                        View on Twitter
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>
            </div>
        {% elif twitter_connection %}
            {% if snippet.status == 'approved' %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">@{{ twitter_connection.platform_username }}</p>
                            <p class="text-xs text-gray-500">Connected account</p>
                        </div>
                    </div>
                    <form action="{{ url_for('social.post_snippet', snippet_id=snippet.id) }}" method="POST" onsubmit="return confirm('Post this content to Twitter?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="inline-flex items-center gap-2 bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 font-medium text-sm">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                            Post to Twitter
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <strong>Status: {{ snippet.status|title }}</strong> - Change status to "Approved" to enable posting.
                    </p>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-4">
                <p class="text-gray-600 mb-3">Connect your Twitter account to post directly from Creator Hub</p>
                <a href="{{ url_for('social.connections') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 font-medium text-sm">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    Connect Twitter
                </a>
            </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
const maxLength = {{ platform_config.max_length if platform_config else 280 }};

function updateCharCount() {
    const editor = document.getElementById('content-editor');
    const counter = document.getElementById('char-count');
    const length = editor.value.length;

    counter.textContent = `${length} / ${maxLength} chars`;

    if (length > maxLength) {
        counter.classList.add('text-red-600', 'font-medium');
        counter.classList.remove('text-gray-500');
    } else {
        counter.classList.remove('text-red-600', 'font-medium');
        counter.classList.add('text-gray-500');
    }
}

async function copyContent() {
    const editor = document.getElementById('content-editor');
    try {
        await navigator.clipboard.writeText(editor.value);
        // Brief feedback
        const btn = event.currentTarget;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 1000);
    } catch (err) {
        console.error('Failed to copy:', err);
    }
}
</script>
{% endblock %}
