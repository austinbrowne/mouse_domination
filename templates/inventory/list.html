{% extends "base.html" %}

{% block title %}Inventory - Mouse Domination{% endblock %}

{% block content %}
<div class="space-y-6" x-data="inventoryFilters()">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Inventory</h1>
            <p class="text-sm text-gray-500 mt-1">
                <span x-text="itemCount">{{ items|length }}</span> items | P/L:
                <span :class="profitLoss >= 0 ? 'text-emerald-600' : 'text-red-600'" class="font-medium">$<span x-text="profitLoss.toFixed(2)">{{ "%.2f"|format(total_profit_loss) }}</span></span>
            </p>
        </div>
        <a href="{{ url_for('inventory.new_item') }}" class="inline-flex items-center gap-2 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 text-sm font-medium shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Add Item
        </a>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl border border-surface-200 p-4">
        <div class="flex flex-wrap gap-3 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-medium text-gray-600 mb-1.5">Search</label>
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" x-model="search" x-ref="searchInput" @input.debounce.300ms="applyFilters()" placeholder="Search products..."
                        class="w-full border border-surface-200 rounded-lg pl-10 pr-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <div x-show="loading" class="absolute right-3 top-1/2 -translate-y-1/2">
                        <svg class="animate-spin w-4 h-4 text-primary-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Type Dropdown -->
            <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <label class="block text-xs font-medium text-gray-600 mb-1.5">Type</label>
                <button type="button" @click="open = !open"
                    class="flex items-center justify-between gap-2 min-w-[140px] border border-surface-200 rounded-lg px-3 py-2 text-sm bg-white hover:bg-surface-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <span x-text="sourceTypeLabel"></span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="open" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                    class="absolute z-20 mt-1 w-full bg-white border border-surface-200 rounded-lg shadow-lg py-1">
                    <button type="button" @click="sourceType = ''; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': sourceType === '' }">All Types</button>
                    <button type="button" @click="sourceType = 'review_unit'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': sourceType === 'review_unit' }">Review Unit</button>
                    <button type="button" @click="sourceType = 'personal_purchase'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': sourceType === 'personal_purchase' }">Personal Purchase</button>
                </div>
            </div>

            <!-- Category Dropdown -->
            <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <label class="block text-xs font-medium text-gray-600 mb-1.5">Category</label>
                <button type="button" @click="open = !open"
                    class="flex items-center justify-between gap-2 min-w-[140px] border border-surface-200 rounded-lg px-3 py-2 text-sm bg-white hover:bg-surface-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <span x-text="categoryLabel"></span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="open" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                    class="absolute z-20 mt-1 w-full bg-white border border-surface-200 rounded-lg shadow-lg py-1">
                    <button type="button" @click="category = ''; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': category === '' }">All Categories</button>
                    <button type="button" @click="category = 'mouse'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': category === 'mouse' }">Mouse</button>
                    <button type="button" @click="category = 'keyboard'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': category === 'keyboard' }">Keyboard</button>
                    <button type="button" @click="category = 'mousepad'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': category === 'mousepad' }">Mousepad</button>
                    <button type="button" @click="category = 'iem'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': category === 'iem' }">IEM</button>
                    <button type="button" @click="category = 'other'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': category === 'other' }">Other</button>
                </div>
            </div>

            <!-- Status Dropdown -->
            <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <label class="block text-xs font-medium text-gray-600 mb-1.5">Status</label>
                <button type="button" @click="open = !open"
                    class="flex items-center justify-between gap-2 min-w-[140px] border border-surface-200 rounded-lg px-3 py-2 text-sm bg-white hover:bg-surface-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <span x-text="statusLabel"></span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="open" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                    class="absolute z-20 mt-1 w-full bg-white border border-surface-200 rounded-lg shadow-lg py-1 max-h-64 overflow-y-auto">
                    <button type="button" @click="status = ''; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === '' }">All Statuses</button>
                    <button type="button" @click="status = 'in_queue'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'in_queue' }">In Queue</button>
                    <button type="button" @click="status = 'reviewing'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'reviewing' }">Reviewing</button>
                    <button type="button" @click="status = 'reviewed'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'reviewed' }">Reviewed</button>
                    <button type="button" @click="status = 'keeping'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'keeping' }">Keeping</button>
                    <button type="button" @click="status = 'listed'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'listed' }">Listed</button>
                    <button type="button" @click="status = 'sold'; open = false; applyFilters()" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 hover:text-primary-700" :class="{ 'bg-primary-50 text-primary-700': status === 'sold' }">Sold</button>
                </div>
            </div>

            <div class="flex items-end">
                <button type="button" @click="clearFilters()" class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm">Clear</button>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" :class="{ 'opacity-50': loading }">
        {% include "inventory/_table.html" %}
    </div>
</div>

<script>
    const updateFieldUrlBase = '{{ url_for("inventory.update_field", id=0) }}'.replace('/0/', '/{id}/');

    function inventoryFilters() {
        return {
            search: '{{ search or "" }}',
            sourceType: '{{ current_source_type or "" }}',
            category: '{{ current_category or "" }}',
            status: '{{ current_status or "" }}',
            loading: false,
            itemCount: {{ items|length }},
            profitLoss: {{ total_profit_loss }},

            get sourceTypeLabel() {
                const labels = { '': 'All Types', 'review_unit': 'Review Unit', 'personal_purchase': 'Personal Purchase' };
                return labels[this.sourceType] || 'All Types';
            },
            get categoryLabel() {
                const labels = { '': 'All Categories', 'mouse': 'Mouse', 'keyboard': 'Keyboard', 'mousepad': 'Mousepad', 'iem': 'IEM', 'other': 'Other' };
                return labels[this.category] || 'All Categories';
            },
            get statusLabel() {
                const labels = { '': 'All Statuses', 'in_queue': 'In Queue', 'reviewing': 'Reviewing', 'reviewed': 'Reviewed', 'keeping': 'Keeping', 'listed': 'Listed', 'sold': 'Sold' };
                return labels[this.status] || 'All Statuses';
            },

            async applyFilters() {
                this.loading = true;
                const params = new URLSearchParams();
                if (this.search) params.set('search', this.search);
                if (this.sourceType) params.set('source_type', this.sourceType);
                if (this.category) params.set('category', this.category);
                if (this.status) params.set('status', this.status);
                params.set('ajax', '1');

                try {
                    const response = await fetch('{{ url_for("inventory.list_inventory") }}?' + params.toString());
                    const html = await response.text();
                    document.getElementById('results-container').innerHTML = html;

                    // Update stats from hidden element
                    const stats = document.getElementById('inventory-stats');
                    if (stats) {
                        this.itemCount = parseInt(stats.dataset.count) || 0;
                        this.profitLoss = parseFloat(stats.dataset.profitLoss) || 0;
                    }

                    // Update URL without reload (for bookmarking/sharing)
                    const urlParams = new URLSearchParams();
                    if (this.search) urlParams.set('search', this.search);
                    if (this.sourceType) urlParams.set('source_type', this.sourceType);
                    if (this.category) urlParams.set('category', this.category);
                    if (this.status) urlParams.set('status', this.status);
                    const newUrl = '{{ url_for("inventory.list_inventory") }}' + (urlParams.toString() ? '?' + urlParams.toString() : '');
                    history.replaceState(null, '', newUrl);
                } catch (error) {
                    console.error('Search failed:', error);
                }

                this.loading = false;
            },

            clearFilters() {
                this.search = '';
                this.sourceType = '';
                this.category = '';
                this.status = '';
                this.applyFilters();
            }
        }
    }

    function inlineDropdown(itemId, field, initialValue) {
        return {
            open: false,
            value: initialValue,
            saving: false,
            dropdownStyle: '',

            sourceTypeLabels: { 'review_unit': 'Review Unit', 'personal_purchase': 'Personal Purchase' },
            sourceTypeClasses: {
                'review_unit': 'bg-blue-50 text-blue-700',
                'personal_purchase': 'bg-violet-50 text-violet-700'
            },

            statusLabels: {
                'in_queue': 'In Queue', 'reviewing': 'Reviewing', 'reviewed': 'Reviewed',
                'keeping': 'Keeping', 'listed': 'Listed', 'sold': 'Sold'
            },
            statusClasses: {
                'in_queue': 'bg-amber-50 text-amber-700',
                'reviewing': 'bg-blue-50 text-blue-700',
                'reviewed': 'bg-violet-50 text-violet-700',
                'keeping': 'bg-gray-100 text-gray-700',
                'listed': 'bg-orange-50 text-orange-700',
                'sold': 'bg-emerald-50 text-emerald-700'
            },

            toggleDropdown() {
                if (!this.open) {
                    const button = this.$refs.button;
                    const rect = button.getBoundingClientRect();
                    this.dropdownStyle = `position: fixed; top: ${rect.bottom + 4}px; left: ${rect.left}px;`;
                }
                this.open = !this.open;
            },

            async updateField(newValue) {
                if (this.value === newValue) {
                    this.open = false;
                    return;
                }

                this.saving = true;
                const formData = new FormData();
                formData.append('field', field);
                formData.append('value', newValue);
                formData.append('csrf_token', '{{ csrf_token() }}');

                const url = updateFieldUrlBase.replace('{id}', itemId);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        this.value = newValue;
                        this.$el.closest('td').setAttribute('data-value', newValue);
                    } else {
                        alert('Failed to update: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Update failed:', error);
                    alert('Failed to update. Please try again.');
                }

                this.saving = false;
                this.open = false;
            }
        }
    }
</script>
{% endblock %}
