{% extends "base.html" %}

{% block title %}Calendar - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="space-y-6" x-data="calendarApp()">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">Calendar</h1>
        <div class="flex items-center gap-2">
            <button @click="viewMode = 'month'" :class="viewMode === 'month' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'" class="px-4 py-2 text-sm font-medium rounded-lg transition">
                Month
            </button>
            <button @click="viewMode = 'week'" :class="viewMode === 'week' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'" class="px-4 py-2 text-sm font-medium rounded-lg transition">
                Week
            </button>
            <button @click="goToToday()" class="px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
                Today
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="bg-white rounded-xl border border-surface-200 p-4">
        <div class="flex items-center justify-between mb-4">
            <button @click="previousPeriod()" class="p-2 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <h2 class="text-lg font-semibold text-gray-900" x-text="currentPeriodLabel"></h2>
            <button @click="nextPeriod()" class="p-2 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap gap-4 mb-4 text-sm">
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-gray-600">Deadline</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span class="text-gray-600">Return</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                <span class="text-gray-600">Episode</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-gray-600">Pipeline</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-teal-500"></span>
                <span class="text-gray-600">Deliverable</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                <span class="text-gray-600">Payment</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-pink-500"></span>
                <span class="text-gray-600">Collab</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                <span class="text-gray-600">Follow-up</span>
            </div>
        </div>

        <!-- Month View -->
        <div x-show="viewMode === 'month'" class="overflow-hidden">
            <!-- Day Headers -->
            <div class="grid grid-cols-7 border-b border-surface-200">
                <template x-for="day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']" :key="day">
                    <div class="py-2 text-center text-sm font-medium text-gray-500" x-text="day"></div>
                </template>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7">
                <template x-for="(week, weekIndex) in calendarWeeks" :key="weekIndex">
                    <template x-for="(day, dayIndex) in week" :key="weekIndex + '-' + dayIndex">
                        <div class="min-h-[100px] border-b border-r border-surface-200 p-1"
                             :class="{'bg-surface-50': !day.isCurrentMonth, 'bg-blue-50': day.isToday}">
                            <div class="text-sm font-medium mb-1" :class="day.isCurrentMonth ? 'text-gray-900' : 'text-gray-400'" x-text="day.date"></div>
                            <div class="space-y-0.5">
                                <template x-for="event in getEventsForDate(day.fullDate)" :key="event.id">
                                    <a :href="event.url"
                                       class="block text-xs px-1.5 py-0.5 rounded truncate text-white hover:opacity-80"
                                       :style="'background-color: ' + event.color"
                                       :title="event.title"
                                       x-text="event.title.length > 20 ? event.title.substring(0, 20) + '...' : event.title">
                                    </a>
                                </template>
                            </div>
                        </div>
                    </template>
                </template>
            </div>
        </div>

        <!-- Week View -->
        <div x-show="viewMode === 'week'" class="overflow-hidden">
            <!-- Day Headers -->
            <div class="grid grid-cols-7 border-b border-surface-200">
                <template x-for="day in weekDays" :key="day.fullDate">
                    <div class="py-2 text-center border-r border-surface-200 last:border-r-0"
                         :class="{'bg-blue-50': day.isToday}">
                        <div class="text-sm font-medium text-gray-500" x-text="day.dayName"></div>
                        <div class="text-lg font-semibold" :class="day.isToday ? 'text-primary-600' : 'text-gray-900'" x-text="day.date"></div>
                    </div>
                </template>
            </div>

            <!-- Week Grid -->
            <div class="grid grid-cols-7">
                <template x-for="day in weekDays" :key="day.fullDate">
                    <div class="min-h-[300px] border-r border-surface-200 last:border-r-0 p-2 space-y-1"
                         :class="{'bg-blue-50': day.isToday}">
                        <template x-for="event in getEventsForDate(day.fullDate)" :key="event.id">
                            <a :href="event.url"
                               class="block text-xs px-2 py-1.5 rounded text-white hover:opacity-80"
                               :style="'background-color: ' + event.color"
                               :title="event.title">
                                <span x-text="event.title"></span>
                            </a>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <!-- Loading indicator -->
        <div x-show="loading" class="flex justify-center py-8">
            <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>
</div>

<script>
function calendarApp() {
    return {
        viewMode: 'month',
        currentDate: new Date(),
        events: [],
        loading: false,

        init() {
            this.fetchEvents();
        },

        get currentPeriodLabel() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            if (this.viewMode === 'month') {
                return `${months[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
            } else {
                const weekStart = this.getWeekStart(this.currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                if (weekStart.getMonth() === weekEnd.getMonth()) {
                    return `${months[weekStart.getMonth()]} ${weekStart.getDate()}-${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
                } else {
                    return `${months[weekStart.getMonth()]} ${weekStart.getDate()} - ${months[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
                }
            }
        },

        get calendarWeeks() {
            const weeks = [];
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Start from Sunday of the week containing the 1st
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let currentWeek = [];
            const current = new Date(startDate);

            while (current <= lastDay || currentWeek.length > 0) {
                const cellDate = new Date(current);
                currentWeek.push({
                    date: cellDate.getDate(),
                    fullDate: this.formatDate(cellDate),
                    isCurrentMonth: cellDate.getMonth() === month,
                    isToday: cellDate.getTime() === today.getTime()
                });

                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                    if (current > lastDay) break;
                }

                current.setDate(current.getDate() + 1);
            }

            return weeks;
        },

        get weekDays() {
            const days = [];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const weekStart = this.getWeekStart(this.currentDate);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(day.getDate() + i);
                days.push({
                    dayName: dayNames[day.getDay()],
                    date: day.getDate(),
                    fullDate: this.formatDate(day),
                    isToday: day.getTime() === today.getTime()
                });
            }

            return days;
        },

        getWeekStart(date) {
            const d = new Date(date);
            d.setDate(d.getDate() - d.getDay());
            return d;
        },

        formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },

        getEventsForDate(dateStr) {
            return this.events.filter(e => e.date === dateStr);
        },

        previousPeriod() {
            if (this.viewMode === 'month') {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
            } else {
                const newDate = new Date(this.currentDate);
                newDate.setDate(newDate.getDate() - 7);
                this.currentDate = newDate;
            }
            this.fetchEvents();
        },

        nextPeriod() {
            if (this.viewMode === 'month') {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
            } else {
                const newDate = new Date(this.currentDate);
                newDate.setDate(newDate.getDate() + 7);
                this.currentDate = newDate;
            }
            this.fetchEvents();
        },

        goToToday() {
            this.currentDate = new Date();
            this.fetchEvents();
        },

        async fetchEvents() {
            this.loading = true;

            // Calculate date range based on view mode
            let startDate, endDate;

            if (this.viewMode === 'month') {
                // Get full month plus buffer for adjacent weeks
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                startDate = new Date(year, month, 1);
                startDate.setDate(startDate.getDate() - 7); // Week before
                endDate = new Date(year, month + 1, 0);
                endDate.setDate(endDate.getDate() + 7); // Week after
            } else {
                // Get current week
                startDate = this.getWeekStart(this.currentDate);
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
            }

            const params = new URLSearchParams({
                start: this.formatDate(startDate),
                end: this.formatDate(endDate)
            });

            try {
                const response = await fetch(`{{ url_for('calendar.get_events') }}?${params}`);
                const data = await response.json();
                this.events = data.events || [];
            } catch (error) {
                console.error('Failed to fetch events:', error);
                this.events = [];
            }

            this.loading = false;
        }
    };
}
</script>
{% endblock %}
