{% extends "base.html" %}

{% block title %}Edit: {{ guide.title }} - {{ APP_NAME }}{% endblock %}

{% macro render_section_content(section_key, show_header=true) %}
<!-- Add Item Form -->
<div x-show="adding" class="p-4 bg-primary-50 border-b border-primary-100" x-data="{ newLinks: [''], newNotes: '' }">
    <div class="space-y-3">
        <input type="text" x-ref="newTitle{{ section_key }}" placeholder="Topic title..."
            class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"
            @keydown.enter.prevent="addItem('{{ section_key }}', $refs.newTitle{{ section_key }}.value, newLinks, newNotes); $refs.newTitle{{ section_key }}.value = ''; newLinks = ['']; newNotes = ''">
        <!-- Multiple link inputs -->
        <div class="space-y-2">
            <template x-for="(link, idx) in newLinks" :key="idx">
                <div class="flex gap-2">
                    <input type="text" x-model="newLinks[idx]" placeholder="Link (optional)..."
                        class="flex-1 border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                    <button type="button" @click="newLinks.splice(idx, 1)" x-show="newLinks.length > 1"
                        class="text-red-500 hover:text-red-700 px-2 text-lg font-bold">-</button>
                </div>
            </template>
            <button type="button" @click="newLinks.push('')" class="text-primary-600 hover:text-primary-700 text-sm font-medium">+ Add Link</button>
        </div>
        <textarea x-model="newNotes" placeholder="Notes (optional)..." rows="2"
            class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"></textarea>
        <div class="flex justify-end gap-2">
            <button type="button" @click="adding = false; newLinks = ['']; newNotes = ''" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
            <button type="button" @click="addItem('{{ section_key }}', $refs.newTitle{{ section_key }}.value, newLinks, newNotes); $refs.newTitle{{ section_key }}.value = ''; newLinks = ['']; newNotes = ''; adding = false"
                class="bg-primary-600 text-white px-4 py-1.5 rounded-lg hover:bg-primary-700 text-sm font-medium">Add Item</button>
        </div>
    </div>
</div>

{% if show_header %}
<!-- Topics Header with Add Button -->
<div class="p-3 bg-surface-50 border-b border-surface-200 flex items-center justify-between">
    <span class="text-xs font-semibold text-gray-500 uppercase">Topics</span>
    <button type="button" @click="adding = true" class="text-primary-600 hover:text-primary-700 text-sm font-medium">+ Add</button>
</div>
{% endif %}

<!-- Items List -->
<div class="divide-y divide-surface-200 sortable-list" id="sortable-{{ section_key }}" data-section="{{ section_key }}">
    <template x-for="(item, idx) in items['{{ section_key }}'] || []" :key="item.id">
        <div :id="'item-' + item.id" class="py-1.5 px-3 hover:bg-surface-50 group sortable-item scroll-mt-24" :class="{'editing': editingItemId === item.id}" :data-id="item.id">
            <!-- View Mode -->
            <div x-show="editingItemId !== item.id" class="flex items-start gap-2">
                <!-- Drag Handle -->
                <div class="drag-handle cursor-grab text-gray-300 hover:text-gray-500 flex-shrink-0" title="Drag to reorder">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/>
                        <circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/>
                        <circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/>
                        <circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/>
                    </svg>
                </div>
                <!-- Topic Number -->
                <span class="text-gray-400 text-xs font-medium flex-shrink-0" x-text="(idx + 1) + '.'"></span>
                <div class="flex-1 min-w-0 cursor-pointer" @click="startEditingItem(item)">
                    <div class="font-medium text-gray-900 text-sm" x-text="item.title"></div>
                    <template x-if="item.links && item.links.length">
                        <div class="space-y-0.5">
                            <template x-for="link in item.links" :key="link">
                                <a :href="link.startsWith('http') ? link : 'https://' + link" target="_blank" @click.stop class="text-xs text-primary-600 hover:underline truncate block" x-text="link"></a>
                            </template>
                        </div>
                    </template>
                    <template x-if="item.notes">
                        <div class="text-xs text-gray-500 mt-1" x-text="item.notes"></div>
                    </template>
                </div>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100">
                    <button type="button" @click="startEditingItem(item)"
                        class="text-gray-400 hover:text-primary-600 p-1" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    </button>
                    <button type="button" @click="deleteItem('{{ section_key }}', item.id)"
                        class="text-gray-400 hover:text-red-600 p-1" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- Edit Mode -->
            <div x-show="editingItemId === item.id" class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
                    <input type="text" x-model="editingItem.title"
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"
                        @keydown.enter.prevent="saveItem('{{ section_key }}')">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Links (optional)</label>
                    <div class="space-y-2">
                        <template x-for="(link, idx) in editingItem.links" :key="idx">
                            <div class="flex gap-2">
                                <input type="text" x-model="editingItem.links[idx]"
                                    class="flex-1 border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                                <button type="button" @click="editingItem.links.splice(idx, 1)" x-show="editingItem.links.length > 1"
                                    class="text-red-500 hover:text-red-700 px-2 text-lg font-bold">-</button>
                            </div>
                        </template>
                        <button type="button" @click="editingItem.links.push('')" class="text-primary-600 hover:text-primary-700 text-sm font-medium">+ Add Link</button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Notes (optional)</label>
                    <textarea x-model="editingItem.notes" rows="2"
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" @click="cancelEditingItem()"
                        class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
                    <button type="button" @click="saveItem('{{ section_key }}')"
                        class="bg-primary-600 text-white px-4 py-1.5 rounded-lg hover:bg-primary-700 text-sm font-medium">Save</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Empty state placeholder for drop target -->
    <div x-show="!items['{{ section_key }}'] || items['{{ section_key }}'].length === 0" class="p-4 text-center text-gray-400 text-xs empty-placeholder">
        No topics yet. Drag items here or click "+ Add".
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="space-y-6" x-data="episodeGuideEdit({{ guide.id }}, '{{ guide.title | e }}', {{ guide.episode_number or 'null' }}, '{{ guide.previous_poll | default('', true) | e }}', '{{ guide.previous_poll_link | default('', true) | e }}', '{{ guide.new_poll | default('', true) | e }}', '{{ guide.new_poll_link | default('', true) | e }}', {{ guide.custom_sections | default([], true) | tojson }})">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <div class="flex items-center gap-3">
                <!-- Editable Episode Number -->
                <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary-100 text-primary-700 font-bold cursor-pointer"
                    @click="editingEpisodeNum = true"
                    x-show="!editingEpisodeNum">
                    <span x-text="episodeNumber ? '#' + episodeNumber : '#'"></span>
                </div>
                <input x-show="editingEpisodeNum" x-ref="episodeNumInput"
                    type="number" x-model="episodeNumber"
                    @blur="saveGuideMetadata(); editingEpisodeNum = false"
                    @keydown.enter="saveGuideMetadata(); editingEpisodeNum = false"
                    @keydown.escape="editingEpisodeNum = false"
                    class="w-16 h-10 text-center border border-primary-300 rounded-full text-primary-700 font-bold focus:ring-2 focus:ring-primary-500">
                <div class="flex-1">
                    <!-- Editable Title -->
                    <h1 class="text-2xl font-bold text-gray-900 cursor-pointer hover:bg-surface-100 px-2 py-1 -mx-2 rounded"
                        x-show="!editingTitle"
                        @click="editingTitle = true; $nextTick(() => $refs.titleInput.focus())"
                        x-text="guideTitle">
                    </h1>
                    <input x-show="editingTitle" x-ref="titleInput"
                        type="text" x-model="guideTitle"
                        @blur="saveGuideMetadata(); editingTitle = false"
                        @keydown.enter="saveGuideMetadata(); editingTitle = false"
                        @keydown.escape="editingTitle = false"
                        class="text-2xl font-bold text-gray-900 w-full border border-primary-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-primary-500">
                    <p class="text-sm text-gray-500">Click title or episode number to edit</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('episode_guide.list_guides') }}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                Back
            </a>
            <a href="{{ url_for('episode_guide.live_mode', id=guide.id) }}" class="inline-flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 text-sm font-medium">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                Go Live
            </a>
        </div>
    </div>

    <!-- Poll Fields -->
    <div class="bg-white rounded-xl border border-surface-200 p-4">
        <h3 class="font-semibold text-gray-900 mb-4">Intro Poll Settings</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Previous Poll -->
            <div class="space-y-2">
                <label class="block text-xs font-semibold text-gray-700 uppercase tracking-wide">Previous Poll (from last episode)</label>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
                    <input type="text" x-model="previousPoll"
                        @blur="saveGuideMetadata()"
                        placeholder="What was last week's poll question?"
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Link</label>
                    <input type="text" x-model="previousPollLink"
                        @blur="saveGuideMetadata()"
                        placeholder="https://x.com/... or poll results link"
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                </div>
            </div>
            <!-- New Poll -->
            <div class="space-y-2">
                <label class="block text-xs font-semibold text-gray-700 uppercase tracking-wide">New Poll (this episode)</label>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
                    <input type="text" x-model="newPoll"
                        @blur="saveGuideMetadata()"
                        placeholder="What's this week's poll question?"
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Link</label>
                    <input type="text" x-model="newPollLink"
                        @blur="saveGuideMetadata()"
                        placeholder="https://x.com/... or new poll link"
                        class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                </div>
            </div>
        </div>
    </div>

    <!-- Sections -->
    <div class="space-y-4">
        <!-- INTRO Section -->
        <div>
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-t-xl px-4 py-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-base font-bold text-white uppercase tracking-wide">INTRO</h2>
                    <span class="text-white/70 text-sm" x-text="'(' + (items['introduction']?.length || 0) + ' topics)'"></span>
                </div>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden" x-data="{ adding: false }">
                {{ render_section_content('introduction') }}
            </div>
        </div>

        <!-- NEWS Section -->
        <div>
            <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-t-xl px-4 py-2">
                <h2 class="text-base font-bold text-white uppercase tracking-wide">NEWS</h2>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden">
                {% for sub_key, sub_name in [('news_mice', 'Mice'), ('news_other', 'Other'), ('news_pads', 'Pads'), ('news_keyboards', 'Keyboards')] %}
                <div x-data="{ collapsed: false, adding: false }" class="{% if not loop.last %}border-b border-surface-200{% endif %}">
                    <div class="flex items-center justify-between p-3 bg-surface-50 cursor-pointer" @click="collapsed = !collapsed">
                        <h3 class="font-semibold text-gray-700">
                            {{ sub_name }}
                            <span class="text-sm font-normal text-gray-500 ml-2" x-text="'(' + (items['{{ sub_key }}']?.length || 0) + ')'"></span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <button type="button" @click.stop="adding = true; collapsed = false" class="text-primary-600 hover:text-primary-700 text-sm font-medium">+ Add</button>
                            <svg class="w-5 h-5 text-gray-400 transition-transform" :class="collapsed ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                    </div>
                    <div x-show="!collapsed" x-collapse>
                        {{ render_section_content(sub_key, show_header=false) }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- COMMUNITY RECAP Section -->
        <div>
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-t-xl px-4 py-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-base font-bold text-white uppercase tracking-wide">COMMUNITY RECAP</h2>
                    <span class="text-white/70 text-sm" x-text="'(' + (items['community_recap']?.length || 0) + ' topics)'"></span>
                </div>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden" x-data="{ adding: false }">
                {{ render_section_content('community_recap') }}
            </div>
        </div>

        <!-- PERSONAL RAMBLINGS Section -->
        <div>
            <div class="bg-gradient-to-r from-amber-600 to-amber-700 rounded-t-xl px-4 py-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-base font-bold text-white uppercase tracking-wide">PERSONAL RAMBLINGS</h2>
                    <span class="text-white/70 text-sm" x-text="'(' + (items['personal_ramblings']?.length || 0) + ' topics)'"></span>
                </div>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden" x-data="{ adding: false }">
                {{ render_section_content('personal_ramblings') }}
            </div>
        </div>

        <!-- OUTRO Section -->
        <div>
            <div class="bg-gradient-to-r from-gray-600 to-gray-700 rounded-t-xl px-4 py-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-base font-bold text-white uppercase tracking-wide">OUTRO</h2>
                    <span class="text-white/70 text-sm" x-text="'(' + (items['outro']?.length || 0) + ' topics)'"></span>
                </div>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden" x-data="{ adding: false }">
                {{ render_section_content('outro') }}
            </div>
        </div>

        <!-- Custom Sections -->
        <template x-for="customSection in customSections" :key="customSection.key">
            <div>
                <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 rounded-t-xl px-4 py-2">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base font-bold text-white uppercase tracking-wide" x-text="customSection.name"></h2>
                        <div class="flex items-center gap-2">
                            <span class="text-white/70 text-sm" x-text="'(' + (items[customSection.key]?.length || 0) + ' topics)'"></span>
                            <button type="button" @click="deleteCustomSection(customSection.key)"
                                    class="text-white/70 hover:text-white p-1" title="Delete section">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden" x-data="{ adding: false }">
                    <!-- Add Item Form -->
                    <div x-show="adding" class="p-4 bg-primary-50 border-b border-primary-100" x-data="{ newLinks: [''], newNotes: '' }">
                        <div class="space-y-3">
                            <input type="text" :x-ref="'newTitle' + customSection.key" placeholder="Topic title..."
                                class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"
                                @keydown.enter.prevent="addItem(customSection.key, $event.target.value, newLinks, newNotes); $event.target.value = ''; newLinks = ['']; newNotes = ''">
                            <div class="space-y-2">
                                <template x-for="(link, idx) in newLinks" :key="idx">
                                    <div class="flex gap-2">
                                        <input type="text" x-model="newLinks[idx]" placeholder="Link (optional)..."
                                            class="flex-1 border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                                        <button type="button" @click="newLinks.splice(idx, 1)" x-show="newLinks.length > 1"
                                            class="text-red-500 hover:text-red-700 px-2 text-lg font-bold">-</button>
                                    </div>
                                </template>
                                <button type="button" @click="newLinks.push('')" class="text-primary-600 hover:text-primary-700 text-sm font-medium">+ Add Link</button>
                            </div>
                            <textarea x-model="newNotes" placeholder="Notes (optional)..." rows="2"
                                class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"></textarea>
                            <div class="flex justify-end gap-2">
                                <button type="button" @click="adding = false; newLinks = ['']; newNotes = ''" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
                                <button type="button" @click="addItem(customSection.key, $el.closest('.space-y-3').querySelector('input[placeholder=\\'Topic title...\\']').value, newLinks, newNotes); $el.closest('.space-y-3').querySelector('input[placeholder=\\'Topic title...\\']').value = ''; newLinks = ['']; newNotes = ''; adding = false"
                                    class="bg-primary-600 text-white px-4 py-1.5 rounded-lg hover:bg-primary-700 text-sm font-medium">Add Item</button>
                            </div>
                        </div>
                    </div>
                    <!-- Topics Header with Add Button -->
                    <div class="p-3 bg-surface-50 border-b border-surface-200 flex items-center justify-between">
                        <span class="text-xs font-semibold text-gray-500 uppercase">Topics</span>
                        <button type="button" @click="adding = true" class="text-primary-600 hover:text-primary-700 text-sm font-medium">+ Add</button>
                    </div>
                    <!-- Items List -->
                    <div class="divide-y divide-surface-200 sortable-list" :id="'sortable-' + customSection.key" :data-section="customSection.key">
                        <template x-for="(item, idx) in items[customSection.key] || []" :key="item.id">
                            <div :id="'item-' + item.id" class="py-1.5 px-3 hover:bg-surface-50 group sortable-item scroll-mt-24" :data-id="item.id">
                                <div class="flex items-start gap-2">
                                    <div class="drag-handle cursor-grab text-gray-300 hover:text-gray-500 flex-shrink-0" title="Drag to reorder">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                            <circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/>
                                            <circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/>
                                            <circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/>
                                            <circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/>
                                        </svg>
                                    </div>
                                    <span class="text-gray-400 text-xs font-medium flex-shrink-0" x-text="(idx + 1) + '.'"></span>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-900 text-sm" x-text="item.title"></div>
                                        <template x-if="item.links && item.links.length">
                                            <div class="space-y-0.5">
                                                <template x-for="link in item.links" :key="link">
                                                    <a :href="link.startsWith('http') ? link : 'https://' + link" target="_blank" class="text-xs text-primary-600 hover:underline truncate block" x-text="link"></a>
                                                </template>
                                            </div>
                                        </template>
                                        <template x-if="item.notes">
                                            <div class="text-xs text-gray-500 mt-1" x-text="item.notes"></div>
                                        </template>
                                    </div>
                                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100">
                                        <button type="button" @click="deleteItem(customSection.key, item.id)"
                                            class="text-gray-400 hover:text-red-600 p-1" title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="!items[customSection.key] || items[customSection.key].length === 0" class="p-4 text-center text-gray-400 text-xs empty-placeholder">
                            No topics yet. Click "+ Add" to add one.
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Add Custom Section Button -->
        <div class="flex justify-center" x-data="{ showForm: false, sectionName: '' }">
            <template x-if="!showForm">
                <button type="button" @click="showForm = true"
                        class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 bg-white border-2 border-dashed border-gray-300 rounded-xl hover:border-primary-400 hover:text-primary-600 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Custom Section
                </button>
            </template>
            <template x-if="showForm">
                <div class="bg-white rounded-xl border border-surface-200 p-4 w-full max-w-md">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Section Name</label>
                            <input type="text" x-model="sectionName" placeholder="e.g., Q&A, Hot Takes, Gear Corner"
                                   class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"
                                   @keydown.enter.prevent="addCustomSection(sectionName); sectionName = ''; showForm = false">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" @click="showForm = false; sectionName = ''" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
                            <button type="button" @click="addCustomSection(sectionName); sectionName = ''; showForm = false"
                                    class="bg-primary-600 text-white px-4 py-1.5 rounded-lg hover:bg-primary-700 text-sm font-medium">Add Section</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SortableJS for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* Drag-and-drop styles */
.sortable-ghost {
    opacity: 0.4;
    background-color: #dbeafe !important;
}
.sortable-chosen {
    background-color: #eff6ff !important;
}
.sortable-drag {
    opacity: 1;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}
.drag-handle {
    cursor: grab;
}
.drag-handle:active {
    cursor: grabbing;
}
.sortable-list {
    min-height: 20px;
}
</style>

<script>
function episodeGuideEdit(guideId, initialTitle, initialEpisodeNum, initialPrevPoll, initialPrevPollLink, initialNewPoll, initialNewPollLink, initialCustomSections) {
    return {
        guideId: guideId,
        guideTitle: initialTitle,
        episodeNumber: initialEpisodeNum,
        previousPoll: initialPrevPoll,
        previousPollLink: initialPrevPollLink,
        newPoll: initialNewPoll,
        newPollLink: initialNewPollLink,
        editingTitle: false,
        editingEpisodeNum: false,
        editingItemId: null,
        editingItem: { title: '', links: [''], notes: '' },
        customSections: initialCustomSections || [],
        items: {{ items_json | tojson | safe }}.reduce((acc, item) => {
            if (!acc[item.section]) acc[item.section] = [];
            acc[item.section].push(item);
            return acc;
        }, {}),
        sortableInstances: [],

        init() {
            // Initialize SortableJS after Alpine has rendered the DOM
            this.$nextTick(() => {
                this.initSortables();
            });
        },

        initSortables() {
            // Destroy existing instances if reinitializing
            this.sortableInstances.forEach(s => s.destroy());
            this.sortableInstances = [];

            // Built-in sections
            const sections = [
                'introduction', 'news_mice', 'news_other', 'news_pads',
                'news_keyboards', 'community_recap', 'personal_ramblings', 'outro'
            ];

            // Add custom sections
            this.customSections.forEach(cs => sections.push(cs.key));

            sections.forEach(section => {
                const el = document.getElementById(`sortable-${section}`);
                if (!el) return;

                const sortable = Sortable.create(el, {
                    group: 'episode-guide-items',
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    filter: '.editing, .empty-placeholder',
                    preventOnFilter: false,
                    onEnd: (evt) => this.handleDragEnd(evt)
                });

                this.sortableInstances.push(sortable);
            });
        },

        async addCustomSection(name) {
            if (!name || !name.trim()) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/sections`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ name: name.trim() })
                });

                const data = await response.json();
                if (data.success) {
                    this.customSections.push(data.section);
                    // Reinitialize sortables after Alpine renders the new section
                    this.$nextTick(() => this.initSortables());
                } else {
                    alert('Failed to add section: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to add custom section:', error);
                alert('Failed to add section. Please try again.');
            }
        },

        async deleteCustomSection(sectionKey) {
            if (!confirm('Delete this section? Any items in it must be moved or deleted first.')) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/sections/${sectionKey}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.customSections = this.customSections.filter(s => s.key !== sectionKey);
                    delete this.items[sectionKey];
                } else {
                    alert('Failed to delete section: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to delete custom section:', error);
                alert('Failed to delete section. Please try again.');
            }
        },

        async handleDragEnd(evt) {
            const itemId = parseInt(evt.item.dataset.id);
            const fromSection = evt.from.dataset.section;
            const toSection = evt.to.dataset.section;
            const newIndex = evt.newIndex;

            // Skip if nothing changed
            if (fromSection === toSection && evt.oldIndex === newIndex) return;

            // Debug logging
            console.log('Moving item:', { itemId, fromSection, toSection, newIndex, guideId: this.guideId });
            const url = `/guide/${this.guideId}/items/move`;
            console.log('Request URL:', url);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        target_section: toSection,
                        new_position: newIndex
                    })
                });

                // Check if response is OK before parsing JSON
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Server error:', response.status, text);
                    this.revertDomMove(evt);
                    alert('Server error: ' + response.status);
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    // Update local Alpine state to match the move
                    this.syncItemsAfterMove(itemId, fromSection, toSection, newIndex, data.item);
                } else {
                    console.error('Move failed:', data.error);
                    this.revertDomMove(evt);
                    alert('Failed to save position: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Move request failed:', error);
                this.revertDomMove(evt);
                alert('Failed to save position. Please try again.');
            }
        },

        syncItemsAfterMove(itemId, fromSection, toSection, newPosition, updatedItem) {
            // Remove from old section in Alpine state
            if (this.items[fromSection]) {
                this.items[fromSection] = this.items[fromSection].filter(i => i.id !== itemId);
            }

            // Add to new section at correct position
            if (!this.items[toSection]) {
                this.items[toSection] = [];
            }

            // Insert the updated item at the new position
            this.items[toSection].splice(newPosition, 0, updatedItem);

            // Update positions in local state to match
            this.items[toSection].forEach((item, idx) => {
                item.position = idx;
            });
            if (fromSection !== toSection && this.items[fromSection]) {
                this.items[fromSection].forEach((item, idx) => {
                    item.position = idx;
                });
            }
        },

        revertDomMove(evt) {
            // Revert the DOM change made by SortableJS
            if (evt.from !== evt.to) {
                // Cross-section move: put the item back in original section
                evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex] || null);
            } else {
                // Same section: reorder back
                const parent = evt.from;
                const children = Array.from(parent.children).filter(c => !c.classList.contains('empty-placeholder'));
                if (evt.oldIndex < evt.newIndex) {
                    parent.insertBefore(evt.item, children[evt.oldIndex] || null);
                } else {
                    parent.insertBefore(evt.item, children[evt.oldIndex + 1] || null);
                }
            }
        },

        async saveGuideMetadata() {
            if (!this.guideTitle.trim()) {
                alert('Title is required');
                return;
            }

            try {
                const response = await fetch(`/guide/${this.guideId}/metadata`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        title: this.guideTitle.trim(),
                        episode_number: this.episodeNumber || null,
                        previous_poll: this.previousPoll || null,
                        previous_poll_link: this.previousPollLink || null,
                        new_poll: this.newPoll || null,
                        new_poll_link: this.newPollLink || null
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                } else if (data.guide && data.guide.previous_poll && !this.previousPoll) {
                    // Auto-populated from previous episode
                    this.previousPoll = data.guide.previous_poll;
                }
            } catch (error) {
                console.error('Failed to save metadata:', error);
            }
        },

        startEditingItem(item) {
            this.editingItemId = item.id;
            this.editingItem = {
                title: item.title,
                links: item.links && item.links.length ? [...item.links] : [''],
                notes: item.notes || ''
            };
        },

        cancelEditingItem() {
            this.editingItemId = null;
            this.editingItem = { title: '', links: [''], notes: '' };
        },

        async saveItem(section) {
            if (!this.editingItem.title.trim()) {
                alert('Title is required');
                return;
            }

            // Filter empty links
            const cleanLinks = this.editingItem.links
                .filter(l => l && l.trim())
                .map(l => l.trim());

            try {
                const response = await fetch(`/guide/${this.guideId}/items/${this.editingItemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        title: this.editingItem.title.trim(),
                        links: cleanLinks.length ? cleanLinks : null,
                        notes: this.editingItem.notes.trim() || null
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the item in our local state
                    const itemIndex = this.items[section].findIndex(i => i.id === this.editingItemId);
                    if (itemIndex !== -1) {
                        this.items[section][itemIndex] = data.item;
                    }
                    this.cancelEditingItem();
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save item:', error);
            }
        },

        async addItem(section, title, links, notes) {
            if (!title || !title.trim()) return;

            // Filter empty links
            const cleanLinks = (links || [])
                .filter(l => l && l.trim())
                .map(l => l.trim());

            try {
                const payload = {
                    section,
                    title: title.trim(),
                    links: cleanLinks.length ? cleanLinks : null,
                    notes: (notes && notes.trim()) || null
                };

                const response = await fetch(`/guide/${this.guideId}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    if (!this.items[section]) this.items[section] = [];
                    this.items[section].push(data.item);
                } else {
                    console.error('Server returned error:', data.error);
                }
            } catch (error) {
                console.error('Failed to add item:', error);
            }
        },

        async deleteItem(section, itemId) {
            if (!confirm('Delete this item?')) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/items/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.items[section] = this.items[section].filter(i => i.id !== itemId);
                }
            } catch (error) {
                console.error('Failed to delete item:', error);
            }
        }
    };
}
</script>
{% endblock %}
