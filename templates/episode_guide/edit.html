{% extends "base.html" %}

{% block title %}Edit: {{ guide.title }} - Mouse Domination{% endblock %}

{% block content %}
<div class="space-y-6" x-data="episodeGuideEdit({{ guide.id }}, '{{ guide.title | e }}', {{ guide.episode_number or 'null' }})">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <div class="flex items-center gap-3">
                <!-- Editable Episode Number -->
                <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary-100 text-primary-700 font-bold cursor-pointer"
                    @click="editingEpisodeNum = true"
                    x-show="!editingEpisodeNum">
                    <span x-text="episodeNumber ? '#' + episodeNumber : '#'"></span>
                </div>
                <input x-show="editingEpisodeNum" x-ref="episodeNumInput"
                    type="number" x-model="episodeNumber"
                    @blur="saveGuideMetadata(); editingEpisodeNum = false"
                    @keydown.enter="saveGuideMetadata(); editingEpisodeNum = false"
                    @keydown.escape="editingEpisodeNum = false"
                    class="w-16 h-10 text-center border border-primary-300 rounded-full text-primary-700 font-bold focus:ring-2 focus:ring-primary-500">
                <div class="flex-1">
                    <!-- Editable Title -->
                    <h1 class="text-2xl font-bold text-gray-900 cursor-pointer hover:bg-surface-100 px-2 py-1 -mx-2 rounded"
                        x-show="!editingTitle"
                        @click="editingTitle = true; $nextTick(() => $refs.titleInput.focus())"
                        x-text="guideTitle">
                    </h1>
                    <input x-show="editingTitle" x-ref="titleInput"
                        type="text" x-model="guideTitle"
                        @blur="saveGuideMetadata(); editingTitle = false"
                        @keydown.enter="saveGuideMetadata(); editingTitle = false"
                        @keydown.escape="editingTitle = false"
                        class="text-2xl font-bold text-gray-900 w-full border border-primary-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-primary-500">
                    <p class="text-sm text-gray-500">Click title or episode number to edit</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('episode_guide.list_guides') }}" class="text-gray-500 hover:text-gray-700 text-sm">Back</a>
            <a href="{{ url_for('episode_guide.live_mode', id=guide.id) }}" class="inline-flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 text-sm font-medium">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                Go Live
            </a>
        </div>
    </div>

    <!-- Sections -->
    <div class="space-y-4">
        {% set current_parent = None %}

        {% for section_key, section_name, parent in all_sections %}
            {% if parent and parent != current_parent %}
                <!-- News parent header -->
                <div class="bg-gray-100 rounded-xl p-3">
                    <h2 class="text-lg font-bold text-gray-700 uppercase tracking-wide">News</h2>
                </div>
                {% set current_parent = parent %}
            {% endif %}

            <div class="bg-white rounded-xl border border-surface-200 overflow-hidden" x-data="{ collapsed: false, adding: false }">
                <!-- Section Header -->
                <div class="flex items-center justify-between p-4 border-b border-surface-200 bg-surface-50 cursor-pointer" @click="collapsed = !collapsed">
                    <h3 class="font-semibold text-gray-900 {% if parent %}ml-4{% endif %}">
                        {{ section_name }}
                        <span class="text-sm font-normal text-gray-500 ml-2" x-text="'(' + (items['{{ section_key }}']?.length || 0) + ')'"></span>
                    </h3>
                    <div class="flex items-center gap-2">
                        <button type="button" @click.stop="adding = true; collapsed = false" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                            + Add
                        </button>
                        <svg class="w-5 h-5 text-gray-400 transition-transform" :class="collapsed ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                </div>

                <!-- Section Content -->
                <div x-show="!collapsed" x-collapse>
                    <!-- Add Item Form -->
                    <div x-show="adding" class="p-4 bg-primary-50 border-b border-primary-100">
                        <div class="space-y-3">
                            <input type="text" x-ref="newTitle{{ section_key }}" placeholder="Topic title..."
                                class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"
                                @keydown.enter.prevent="addItem('{{ section_key }}', $refs.newTitle{{ section_key }}.value, $refs.newLink{{ section_key }}.value); $refs.newTitle{{ section_key }}.value = ''; $refs.newLink{{ section_key }}.value = ''">
                            <input type="text" x-ref="newLink{{ section_key }}" placeholder="Link (optional)..."
                                class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                            <div class="flex justify-end gap-2">
                                <button type="button" @click="adding = false" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
                                <button type="button" @click="addItem('{{ section_key }}', $refs.newTitle{{ section_key }}.value, $refs.newLink{{ section_key }}.value); $refs.newTitle{{ section_key }}.value = ''; $refs.newLink{{ section_key }}.value = ''; adding = false"
                                    class="bg-primary-600 text-white px-4 py-1.5 rounded-lg hover:bg-primary-700 text-sm font-medium">Add Item</button>
                            </div>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div class="divide-y divide-surface-200">
                        <template x-for="item in items['{{ section_key }}'] || []" :key="item.id">
                            <div class="p-4 hover:bg-surface-50 group">
                                <!-- View Mode -->
                                <div x-show="editingItemId !== item.id" class="flex items-start gap-3">
                                    <div class="flex-1 min-w-0 cursor-pointer" @click="startEditingItem(item)">
                                        <div class="font-medium text-gray-900" x-text="item.title"></div>
                                        <template x-if="item.link">
                                            <a :href="item.link" target="_blank" @click.stop class="text-xs text-primary-600 hover:underline truncate block" x-text="item.link"></a>
                                        </template>
                                        <template x-if="item.notes">
                                            <div class="text-xs text-gray-500 mt-1" x-text="item.notes"></div>
                                        </template>
                                    </div>
                                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100">
                                        <button type="button" @click="startEditingItem(item)"
                                            class="text-gray-400 hover:text-primary-600 p-1" title="Edit">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                        </button>
                                        <button type="button" @click="deleteItem('{{ section_key }}', item.id)"
                                            class="text-gray-400 hover:text-red-600 p-1" title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Edit Mode -->
                                <div x-show="editingItemId === item.id" class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
                                        <input type="text" x-model="editingItem.title"
                                            class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"
                                            @keydown.enter.prevent="saveItem('{{ section_key }}')">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Link (optional)</label>
                                        <input type="text" x-model="editingItem.link"
                                            class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Notes (optional)</label>
                                        <textarea x-model="editingItem.notes" rows="2"
                                            class="w-full border border-surface-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500"></textarea>
                                    </div>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" @click="cancelEditingItem()"
                                            class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
                                        <button type="button" @click="saveItem('{{ section_key }}')"
                                            class="bg-primary-600 text-white px-4 py-1.5 rounded-lg hover:bg-primary-700 text-sm font-medium">Save</button>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Empty state -->
                        <template x-if="!items['{{ section_key }}'] || items['{{ section_key }}'].length === 0">
                            <div class="p-8 text-center text-gray-400 text-sm">
                                No items yet. Click "+ Add" to add topics.
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function episodeGuideEdit(guideId, initialTitle, initialEpisodeNum) {
    return {
        guideId: guideId,
        guideTitle: initialTitle,
        episodeNumber: initialEpisodeNum,
        editingTitle: false,
        editingEpisodeNum: false,
        editingItemId: null,
        editingItem: { title: '', link: '', notes: '' },
        items: {{ items_json | tojson | safe }}.reduce((acc, item) => {
            if (!acc[item.section]) acc[item.section] = [];
            acc[item.section].push(item);
            return acc;
        }, {}),

        async saveGuideMetadata() {
            if (!this.guideTitle.trim()) {
                alert('Title is required');
                return;
            }

            try {
                const response = await fetch(`/guide/${this.guideId}/metadata`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        title: this.guideTitle.trim(),
                        episode_number: this.episodeNumber || null
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save metadata:', error);
            }
        },

        startEditingItem(item) {
            this.editingItemId = item.id;
            this.editingItem = {
                title: item.title,
                link: item.link || '',
                notes: item.notes || ''
            };
        },

        cancelEditingItem() {
            this.editingItemId = null;
            this.editingItem = { title: '', link: '', notes: '' };
        },

        async saveItem(section) {
            if (!this.editingItem.title.trim()) {
                alert('Title is required');
                return;
            }

            try {
                const response = await fetch(`/guide/${this.guideId}/items/${this.editingItemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        title: this.editingItem.title.trim(),
                        link: this.editingItem.link.trim() || null,
                        notes: this.editingItem.notes.trim() || null
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the item in our local state
                    const itemIndex = this.items[section].findIndex(i => i.id === this.editingItemId);
                    if (itemIndex !== -1) {
                        this.items[section][itemIndex] = data.item;
                    }
                    this.cancelEditingItem();
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save item:', error);
            }
        },

        async addItem(section, title, link) {
            if (!title.trim()) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ section, title: title.trim(), link: link.trim() || null })
                });

                const data = await response.json();
                if (data.success) {
                    if (!this.items[section]) this.items[section] = [];
                    this.items[section].push(data.item);
                }
            } catch (error) {
                console.error('Failed to add item:', error);
            }
        },

        async deleteItem(section, itemId) {
            if (!confirm('Delete this item?')) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/items/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.items[section] = this.items[section].filter(i => i.id !== itemId);
                }
            } catch (error) {
                console.error('Failed to delete item:', error);
            }
        }
    };
}
</script>
{% endblock %}
