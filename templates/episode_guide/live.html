{% extends "base.html" %}

{% block title %}LIVE: {{ guide.title }} - Mouse Domination{% endblock %}

{% macro render_item(item) %}
<div class="p-4 flex items-center gap-4 hover:bg-surface-50">
    <!-- Discussed checkbox -->
    <input type="checkbox"
        :checked="discussed[{{ item.id }}]"
        @change="toggleDiscussed({{ item.id }}, $event.target.checked)"
        class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">

    <!-- Item content -->
    <div class="flex-1 min-w-0">
        <div class="font-medium text-gray-900" :class="discussed[{{ item.id }}] ? 'line-through text-gray-400' : ''">
            {{ item.title }}
        </div>
        {% if item.link %}
            <a href="{{ item.link if item.link.startswith('http') else 'https://' + item.link }}" target="_blank" class="text-xs text-primary-600 hover:underline truncate block">{{ item.link }}</a>
        {% endif %}
        {% if item.notes %}
            <div class="text-xs text-gray-500 mt-1">{{ item.notes }}</div>
        {% endif %}
    </div>

    <!-- Timestamp display/button -->
    <div class="flex-shrink-0">
        <template x-if="timestamps[{{ item.id }}] !== null && timestamps[{{ item.id }}] !== undefined">
            <span class="inline-flex items-center px-3 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 font-mono font-medium text-sm"
                x-text="formatTime(timestamps[{{ item.id }}])">
            </span>
        </template>
        <template x-if="timestamps[{{ item.id }}] === null || timestamps[{{ item.id }}] === undefined">
            <button @click="markTimestamp({{ item.id }})"
                :disabled="!timerRunning"
                :class="timerRunning ? 'bg-primary-600 hover:bg-primary-700 text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'"
                class="px-4 py-1.5 rounded-lg font-medium text-sm transition-colors">
                MARK
            </button>
        </template>
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="space-y-6" x-data="episodeGuideLive({{ guide.id }}, '{{ guide.status }}', '{{ guide.recording_started_at.isoformat() if guide.recording_started_at else '' }}')">
    <!-- Timer Header -->
    <div class="bg-white rounded-xl border border-surface-200 p-6 text-center sticky top-20 z-40 shadow-lg">
        <div class="flex items-center justify-center gap-4 mb-4">
            {% if guide.episode_number %}
                <span class="text-gray-500">Episode #{{ guide.episode_number }}</span>
            {% endif %}
            <h1 class="text-xl font-bold text-gray-900">{{ guide.title }}</h1>
        </div>

        <!-- Timer Display -->
        <div class="text-6xl font-mono font-bold mb-6" :class="timerRunning ? 'text-red-600' : 'text-gray-400'">
            <span x-text="formatTime(elapsedSeconds)">00:00:00</span>
        </div>

        <!-- Timer Controls -->
        <div class="flex justify-center gap-4">
            <template x-if="!timerRunning && elapsedSeconds === 0">
                <button @click="startRecording()" class="inline-flex items-center gap-2 bg-emerald-600 text-white px-8 py-3 rounded-lg hover:bg-emerald-700 font-medium text-lg">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                    Start Podcast
                </button>
            </template>

            <template x-if="timerRunning">
                <button @click="stopRecording()" class="inline-flex items-center gap-2 bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 font-medium text-lg">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/></svg>
                    Stop Recording
                </button>
            </template>

            <template x-if="!timerRunning && elapsedSeconds > 0">
                <div class="flex gap-4">
                    <button @click="resumeTimer()" class="inline-flex items-center gap-2 bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 font-medium">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                        Resume
                    </button>
                    <a href="{{ url_for('episode_guide.view_guide', id=guide.id) }}" class="inline-flex items-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 font-medium">
                        View Results
                    </a>
                </div>
            </template>
        </div>

        <!-- Recording indicator -->
        <template x-if="timerRunning">
            <div class="flex items-center justify-center gap-2 mt-4 text-red-600">
                <span class="w-3 h-3 bg-red-600 rounded-full animate-pulse"></span>
                <span class="text-sm font-medium">RECORDING</span>
            </div>
        </template>
    </div>

    <!-- Back link -->
    <div class="flex justify-between items-center">
        <a href="{{ url_for('episode_guide.edit_guide', id=guide.id) }}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Back to Edit
        </a>
        <span class="text-sm text-gray-500" x-show="Object.values(timestamps).filter(t => t !== null).length > 0">
            <span x-text="Object.values(timestamps).filter(t => t !== null).length"></span> timestamps captured
        </span>
    </div>

    <!-- Sections -->
    <div class="space-y-6">
        <!-- INTRO Section -->
        <div>
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-t-xl px-6 py-3">
                <h2 class="text-xl font-bold text-white uppercase tracking-wide">INTRO</h2>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden">
                <div class="bg-blue-50 border-b border-blue-100 p-4">
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>"Hello everyone! I'm Phalanges. (and I'm dazztrazak) Welcome to MouseCast"</li>
                        <li>Subscribe</li>
                        <li>Discord - https://discord.gg/xPFzjD8r</li>
                        <li>What mice do you have inbound? & What's on your desk right now?</li>
                        <li class="font-semibold">
                            Previous Poll: {{ guide.previous_poll or '[Not set]' }}
                            {% if guide.previous_poll_link %}
                            <a href="{{ guide.previous_poll_link if guide.previous_poll_link.startswith('http') else 'https://' + guide.previous_poll_link }}" target="_blank" class="text-blue-600 hover:underline ml-2">[Link]</a>
                            {% endif %}
                        </li>
                        <li class="font-semibold">
                            New Poll: {{ guide.new_poll or '[Not set]' }}
                            {% if guide.new_poll_link %}
                            <a href="{{ guide.new_poll_link if guide.new_poll_link.startswith('http') else 'https://' + guide.new_poll_link }}" target="_blank" class="text-blue-600 hover:underline ml-2">[Link]</a>
                            {% endif %}
                        </li>
                    </ul>
                </div>
                {% set intro_items = sections.get('introduction', {}).get('items', []) %}
                {% if intro_items %}
                <div class="p-3 bg-surface-50 border-b border-surface-200">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Topics</span>
                </div>
                <div class="divide-y divide-surface-200">
                    {% for item in intro_items %}
                        {{ render_item(item) }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- NEWS Section -->
        <div>
            <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-t-xl px-6 py-3">
                <h2 class="text-xl font-bold text-white uppercase tracking-wide">NEWS</h2>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden">
                {% for sub_key, sub_name in [('news_mice', 'Mice'), ('news_other', 'Other'), ('news_pads', 'Pads'), ('news_keyboards', 'Keyboards')] %}
                    {% set sub_items = sections.get(sub_key, {}).get('items', []) %}
                    {% if sub_items %}
                    <div class="p-3 bg-surface-50 border-b border-surface-200">
                        <span class="text-sm font-semibold text-gray-700">{{ sub_name }}</span>
                        <span class="text-xs text-gray-500 ml-2">({{ sub_items|length }})</span>
                    </div>
                    <div class="divide-y divide-surface-200">
                        {% for item in sub_items %}
                            {{ render_item(item) }}
                        {% endfor %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- COMMUNITY RECAP Section -->
        <div>
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-t-xl px-6 py-3">
                <h2 class="text-xl font-bold text-white uppercase tracking-wide">COMMUNITY RECAP</h2>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden">
                {% set cr_items = sections.get('community_recap', {}).get('items', []) %}
                {% if cr_items %}
                <div class="p-3 bg-surface-50 border-b border-surface-200">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Topics</span>
                </div>
                <div class="divide-y divide-surface-200">
                    {% for item in cr_items %}
                        {{ render_item(item) }}
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-8 text-center text-gray-400 text-sm">No topics</div>
                {% endif %}
            </div>
        </div>

        <!-- PERSONAL RAMBLINGS Section -->
        <div>
            <div class="bg-gradient-to-r from-amber-600 to-amber-700 rounded-t-xl px-6 py-3">
                <h2 class="text-xl font-bold text-white uppercase tracking-wide">PERSONAL RAMBLINGS</h2>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden">
                {% set pr_items = sections.get('personal_ramblings', {}).get('items', []) %}
                {% if pr_items %}
                <div class="p-3 bg-surface-50 border-b border-surface-200">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Topics</span>
                </div>
                <div class="divide-y divide-surface-200">
                    {% for item in pr_items %}
                        {{ render_item(item) }}
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-8 text-center text-gray-400 text-sm">No topics</div>
                {% endif %}
            </div>
        </div>

        <!-- OUTRO Section -->
        <div>
            <div class="bg-gradient-to-r from-gray-600 to-gray-700 rounded-t-xl px-6 py-3">
                <h2 class="text-xl font-bold text-white uppercase tracking-wide">OUTRO</h2>
            </div>
            <div class="bg-white rounded-b-xl border border-t-0 border-surface-200 overflow-hidden">
                <div class="bg-blue-50 border-b border-blue-100 p-4">
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>"Thank you all for listening."</li>
                        <li>MouseCast next week - [UPDATE DATE/TIME]</li>
                        <li>Like & share the video, it helps the algorithm.</li>
                        <li>If you have a question or want to submit a discussion topic, leave it in the comments!</li>
                        <li>We'll be back next Friday with another episode.</li>
                    </ul>
                </div>
                {% set outro_items = sections.get('outro', {}).get('items', []) %}
                {% if outro_items %}
                <div class="p-3 bg-surface-50 border-b border-surface-200">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Topics</span>
                </div>
                <div class="divide-y divide-surface-200">
                    {% for item in outro_items %}
                        {{ render_item(item) }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function episodeGuideLive(guideId, initialStatus, startedAtISO) {
    return {
        guideId: guideId,
        timerRunning: initialStatus === 'recording',
        elapsedSeconds: 0,
        timerInterval: null,
        startTime: startedAtISO ? new Date(startedAtISO) : null,

        // Item state
        timestamps: {
            {% for section_key in sections %}
                {% for item in sections[section_key].get('items', []) %}
                    {{ item.id }}: {{ item.timestamp_seconds if item.timestamp_seconds is not none else 'null' }},
                {% endfor %}
            {% endfor %}
        },
        discussed: {
            {% for section_key in sections %}
                {% for item in sections[section_key].get('items', []) %}
                    {{ item.id }}: {{ 'true' if item.discussed else 'false' }},
                {% endfor %}
            {% endfor %}
        },

        init() {
            // If status is draft, clear any stale localStorage and start fresh
            if ('{{ guide.status }}' === 'draft') {
                localStorage.removeItem(`guide_${this.guideId}_state`);
                this.startTime = null;
                this.timerRunning = false;
                this.elapsedSeconds = 0;
                return;
            }

            // Resume timer if already recording (use client-side tracking)
            if (this.timerRunning && this.startTime) {
                this.elapsedSeconds = Math.max(0, Math.floor((Date.now() - this.startTime.getTime()) / 1000));
                this.startTimerInterval();
            }

            // Try to restore from localStorage (only if not already set from server)
            const saved = localStorage.getItem(`guide_${this.guideId}_state`);
            if (saved && !this.startTime) {
                const state = JSON.parse(saved);
                if (state.startTime) {
                    this.startTime = new Date(state.startTime);
                    this.elapsedSeconds = Math.max(0, Math.floor((Date.now() - this.startTime.getTime()) / 1000));
                    if (state.timerRunning) {
                        this.timerRunning = true;
                        this.startTimerInterval();
                    }
                }
            }
        },

        formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        },

        startTimerInterval() {
            this.timerInterval = setInterval(() => {
                this.elapsedSeconds = Math.floor((Date.now() - this.startTime.getTime()) / 1000);
            }, 1000);
        },

        async startRecording() {
            try {
                // Use client time to avoid timezone issues
                const clientStartTime = new Date();

                const response = await fetch(`/guide/${this.guideId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.startTime = clientStartTime;
                    this.timerRunning = true;
                    this.elapsedSeconds = 0;
                    this.startTimerInterval();
                    this.saveState();
                }
            } catch (error) {
                console.error('Failed to start recording:', error);
            }
        },

        resumeTimer() {
            if (this.startTime) {
                this.timerRunning = true;
                this.startTimerInterval();
                this.saveState();
            }
        },

        async stopRecording() {
            if (!confirm('Stop recording? You can view the results after stopping.')) return;

            clearInterval(this.timerInterval);
            this.timerRunning = false;

            try {
                const response = await fetch(`/guide/${this.guideId}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ elapsed_seconds: this.elapsedSeconds })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.removeItem(`guide_${this.guideId}_state`);
                    window.location.href = `/guide/${this.guideId}`;
                }
            } catch (error) {
                console.error('Failed to stop recording:', error);
            }
        },

        async markTimestamp(itemId) {
            if (!this.timerRunning) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/timestamp/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ elapsed_seconds: this.elapsedSeconds })
                });

                const data = await response.json();
                if (data.success) {
                    this.timestamps[itemId] = data.timestamp_seconds;
                    this.discussed[itemId] = true;
                }
            } catch (error) {
                console.error('Failed to capture timestamp:', error);
            }
        },

        async toggleDiscussed(itemId, discussed) {
            this.discussed[itemId] = discussed;

            try {
                await fetch(`/guide/${this.guideId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ discussed })
                });
            } catch (error) {
                console.error('Failed to update discussed status:', error);
            }
        },

        saveState() {
            localStorage.setItem(`guide_${this.guideId}_state`, JSON.stringify({
                startTime: this.startTime?.toISOString(),
                timerRunning: this.timerRunning
            }));
        }
    };
}
</script>
{% endblock %}
