{% extends "base.html" %}

{% block title %}LIVE: {{ guide.title }} - Mouse Domination{% endblock %}

{% block content %}
<div class="space-y-6" x-data="episodeGuideLive({{ guide.id }}, '{{ guide.status }}', '{{ guide.recording_started_at.isoformat() if guide.recording_started_at else '' }}')">
    <!-- Timer Header -->
    <div class="bg-white rounded-xl border border-surface-200 p-6 text-center sticky top-20 z-40 shadow-lg">
        <div class="flex items-center justify-center gap-4 mb-4">
            {% if guide.episode_number %}
                <span class="text-gray-500">Episode #{{ guide.episode_number }}</span>
            {% endif %}
            <h1 class="text-xl font-bold text-gray-900">{{ guide.title }}</h1>
        </div>

        <!-- Timer Display -->
        <div class="text-6xl font-mono font-bold mb-6" :class="timerRunning ? 'text-red-600' : 'text-gray-400'">
            <span x-text="formatTime(elapsedSeconds)">00:00:00</span>
        </div>

        <!-- Timer Controls -->
        <div class="flex justify-center gap-4">
            <template x-if="!timerRunning && elapsedSeconds === 0">
                <button @click="startRecording()" class="inline-flex items-center gap-2 bg-emerald-600 text-white px-8 py-3 rounded-lg hover:bg-emerald-700 font-medium text-lg">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                    Start Podcast
                </button>
            </template>

            <template x-if="timerRunning">
                <button @click="stopRecording()" class="inline-flex items-center gap-2 bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 font-medium text-lg">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/></svg>
                    Stop Recording
                </button>
            </template>

            <template x-if="!timerRunning && elapsedSeconds > 0">
                <div class="flex gap-4">
                    <button @click="resumeTimer()" class="inline-flex items-center gap-2 bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 font-medium">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                        Resume
                    </button>
                    <a href="{{ url_for('episode_guide.view_guide', id=guide.id) }}" class="inline-flex items-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 font-medium">
                        View Results
                    </a>
                </div>
            </template>
        </div>

        <!-- Recording indicator -->
        <template x-if="timerRunning">
            <div class="flex items-center justify-center gap-2 mt-4 text-red-600">
                <span class="w-3 h-3 bg-red-600 rounded-full animate-pulse"></span>
                <span class="text-sm font-medium">RECORDING</span>
            </div>
        </template>
    </div>

    <!-- Back link -->
    <div class="flex justify-between items-center">
        <a href="{{ url_for('episode_guide.edit_guide', id=guide.id) }}" class="text-gray-500 hover:text-gray-700 text-sm">
            &larr; Back to Edit
        </a>
        <span class="text-sm text-gray-500" x-show="Object.values(timestamps).filter(t => t !== null).length > 0">
            <span x-text="Object.values(timestamps).filter(t => t !== null).length"></span> timestamps captured
        </span>
    </div>

    <!-- Sections -->
    <div class="space-y-4">
        {% set current_parent = namespace(value=None) %}

        {% for section_key, section_name, parent in all_sections %}
            {% if parent and parent != current_parent.value %}
                <div class="bg-gray-100 rounded-xl p-3">
                    <h2 class="text-lg font-bold text-gray-700 uppercase tracking-wide">News</h2>
                </div>
                {% set current_parent.value = parent %}
            {% endif %}

            {% set section_data = sections.get(section_key, {}) %}
            {% set section_items = section_data.get('items', []) %}

            <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
                <!-- Banner Reminder -->
                <div class="bg-red-600 text-white px-4 py-2 text-center font-bold text-sm uppercase tracking-wide">
                    SWITCH BANNER TO: {{ section_name }}
                </div>

                <!-- Section Header -->
                <div class="p-4 border-b border-surface-200 bg-surface-50">
                    <h3 class="font-semibold text-gray-900 {% if parent %}ml-4{% endif %}">
                        {{ section_name }}
                        <span class="text-sm font-normal text-gray-500 ml-2">({{ section_items|length }})</span>
                    </h3>
                </div>

                <!-- Static content for Introduction -->
                {% if section_key == 'introduction' %}
                <div class="bg-blue-50 border-b border-blue-100 p-4">
                    <p class="text-xs font-semibold text-blue-700 uppercase mb-2">Standard Intro Script</p>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>"Hello everyone! I'm Phalanges. (and I'm dazztrazak) Welcome to MouseCast"</li>
                        <li>Subscribe</li>
                        <li>Discord - https://discord.gg/xPFzjD8r</li>
                        <li>Shoutout aubi pinned hand message and other helpful things. People, join the discord!</li>
                        <li>What mice do you have inbound? & What's on your desk right now?</li>
                        <li>Dazz Days of Giveaways</li>
                        <li>Previous Poll: [UPDATE]</li>
                        <li>New Poll: [UPDATE]</li>
                    </ul>
                </div>
                {% endif %}

                <!-- Static content for Outro -->
                {% if section_key == 'outro' %}
                <div class="bg-blue-50 border-b border-blue-100 p-4">
                    <p class="text-xs font-semibold text-blue-700 uppercase mb-2">Standard Outro Script</p>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>"Thank you all for listening."</li>
                        <li>MouseCast next week - [UPDATE DATE/TIME]</li>
                        <li>Like & share the video, it helps the algorithm.</li>
                        <li>If you have a question or want to submit a discussion topic, leave it in the comments!</li>
                        <li>We'll be back next Friday with another episode.</li>
                    </ul>
                </div>
                {% endif %}

                <!-- Items -->
                {% if section_items %}
                    <div class="divide-y divide-surface-200">
                        {% for item in section_items %}
                            <div class="p-4 flex items-center gap-4 hover:bg-surface-50">
                                <!-- Discussed checkbox -->
                                <input type="checkbox"
                                    :checked="discussed[{{ item.id }}]"
                                    @change="toggleDiscussed({{ item.id }}, $event.target.checked)"
                                    class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">

                                <!-- Item content -->
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900" :class="discussed[{{ item.id }}] ? 'line-through text-gray-400' : ''">
                                        {{ item.title }}
                                    </div>
                                    {% if item.link %}
                                        <a href="{{ item.link }}" target="_blank" class="text-xs text-primary-600 hover:underline truncate block">{{ item.link }}</a>
                                    {% endif %}
                                    {% if item.notes %}
                                        <div class="text-xs text-gray-500 mt-1">{{ item.notes }}</div>
                                    {% endif %}
                                </div>

                                <!-- Timestamp display/button -->
                                <div class="flex-shrink-0">
                                    <template x-if="timestamps[{{ item.id }}] !== null && timestamps[{{ item.id }}] !== undefined">
                                        <span class="inline-flex items-center px-3 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 font-mono font-medium text-sm"
                                            x-text="formatTime(timestamps[{{ item.id }}])">
                                        </span>
                                    </template>
                                    <template x-if="timestamps[{{ item.id }}] === null || timestamps[{{ item.id }}] === undefined">
                                        <button @click="markTimestamp({{ item.id }})"
                                            :disabled="!timerRunning"
                                            :class="timerRunning ? 'bg-primary-600 hover:bg-primary-700 text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'"
                                            class="px-4 py-1.5 rounded-lg font-medium text-sm transition-colors">
                                            MARK
                                        </button>
                                    </template>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="p-8 text-center text-gray-400 text-sm">
                        No items in this section
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function episodeGuideLive(guideId, initialStatus, startedAtISO) {
    return {
        guideId: guideId,
        timerRunning: initialStatus === 'recording',
        elapsedSeconds: 0,
        timerInterval: null,
        startTime: startedAtISO ? new Date(startedAtISO) : null,

        // Item state
        timestamps: {
            {% for section_key in sections %}
                {% for item in sections[section_key].get('items', []) %}
                    {{ item.id }}: {{ item.timestamp_seconds if item.timestamp_seconds is not none else 'null' }},
                {% endfor %}
            {% endfor %}
        },
        discussed: {
            {% for section_key in sections %}
                {% for item in sections[section_key].get('items', []) %}
                    {{ item.id }}: {{ 'true' if item.discussed else 'false' }},
                {% endfor %}
            {% endfor %}
        },

        init() {
            // Resume timer if already recording
            if (this.timerRunning && this.startTime) {
                this.elapsedSeconds = Math.floor((Date.now() - this.startTime.getTime()) / 1000);
                this.startTimerInterval();
            }

            // Try to restore from localStorage
            const saved = localStorage.getItem(`guide_${this.guideId}_state`);
            if (saved) {
                const state = JSON.parse(saved);
                if (state.startTime && !this.startTime) {
                    this.startTime = new Date(state.startTime);
                    if (state.timerRunning) {
                        this.timerRunning = true;
                        this.elapsedSeconds = Math.floor((Date.now() - this.startTime.getTime()) / 1000);
                        this.startTimerInterval();
                    }
                }
            }
        },

        formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        },

        startTimerInterval() {
            this.timerInterval = setInterval(() => {
                this.elapsedSeconds = Math.floor((Date.now() - this.startTime.getTime()) / 1000);
            }, 1000);
        },

        async startRecording() {
            try {
                const response = await fetch(`/guide/${this.guideId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    this.startTime = new Date(data.started_at);
                    this.timerRunning = true;
                    this.elapsedSeconds = 0;
                    this.startTimerInterval();
                    this.saveState();
                }
            } catch (error) {
                console.error('Failed to start recording:', error);
            }
        },

        resumeTimer() {
            if (this.startTime) {
                this.timerRunning = true;
                this.startTimerInterval();
                this.saveState();
            }
        },

        async stopRecording() {
            if (!confirm('Stop recording? You can view the results after stopping.')) return;

            clearInterval(this.timerInterval);
            this.timerRunning = false;

            try {
                const response = await fetch(`/guide/${this.guideId}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ elapsed_seconds: this.elapsedSeconds })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.removeItem(`guide_${this.guideId}_state`);
                    window.location.href = `/guide/${this.guideId}`;
                }
            } catch (error) {
                console.error('Failed to stop recording:', error);
            }
        },

        async markTimestamp(itemId) {
            if (!this.timerRunning) return;

            try {
                const response = await fetch(`/guide/${this.guideId}/timestamp/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ elapsed_seconds: this.elapsedSeconds })
                });

                const data = await response.json();
                if (data.success) {
                    this.timestamps[itemId] = data.timestamp_seconds;
                    this.discussed[itemId] = true;
                }
            } catch (error) {
                console.error('Failed to capture timestamp:', error);
            }
        },

        async toggleDiscussed(itemId, discussed) {
            this.discussed[itemId] = discussed;

            try {
                await fetch(`/guide/${this.guideId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ discussed })
                });
            } catch (error) {
                console.error('Failed to update discussed status:', error);
            }
        },

        saveState() {
            localStorage.setItem(`guide_${this.guideId}_state`, JSON.stringify({
                startTime: this.startTime?.toISOString(),
                timerRunning: this.timerRunning
            }));
        }
    };
}
</script>
{% endblock %}
